from __future__ import annotations

import json
import random
import datetime as dt
from pathlib import Path

import streamlit as st

APP_TITLE = "ğŸ’— æ‹æ„›å¤¢è¨ºæ–­ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆDay58ï¼‰"

BASE_DIR = Path(__file__).parent
DATA_DIR = BASE_DIR / "data"
DATA_DIR.mkdir(exist_ok=True)
HISTORY_PATH = DATA_DIR / "history.json"

DISCLAIMER = "â€»ã“ã‚Œã¯å‰µä½œçš„ãƒ»å¿ƒç†çš„ãªè§£é‡ˆï¼ˆãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³å«ã‚€ï¼‰ã§ã™ã€‚ç›¸æ‰‹ã®æ°—æŒã¡ã®æ–­å®šãƒ»æœªæ¥ã®ä¿è¨¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"


# -------------------------
# ä¿å­˜/èª­è¾¼
# -------------------------
def load_history():
    if not HISTORY_PATH.exists():
        return []
    try:
        return json.loads(HISTORY_PATH.read_text(encoding="utf-8"))
    except Exception:
        return []


def save_history(rows):
    HISTORY_PATH.write_text(json.dumps(rows, ensure_ascii=False, indent=2), encoding="utf-8")


# -------------------------
# æ‹æ„›å¤¢ã‚·ãƒ³ãƒœãƒ«ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åˆæˆï¼‰
# -------------------------
LOVE_SIGNS = {
    "æ‰‹ã‚’ã¤ãªã/è§¦ã‚Œåˆã†": {
        "surface": [
            "ã¤ãªãŒã‚Šãƒ»å®‰å¿ƒãƒ»è¦ªå¯†ã•ã¸ã®æ¬²æ±‚ã®è±¡å¾´ã€‚é–¢ä¿‚ã‚’æ·±ã‚ãŸã„æ°—æŒã¡ãŒå‡ºã‚„ã™ã„ã€‚",
            "ã€ã‚‚ã£ã¨åˆ†ã‹ã‚Šåˆã„ãŸã„ã€ã¨ã„ã†ã‚µã‚¤ãƒ³ã¨ã—ã¦ç¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚",
        ],
        "deep": [
            "æœ¬éŸ³ã‚’è¨€ãˆã‚‹è·é›¢ã‚’æ±‚ã‚ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚è¨€è‘‰ã‚ˆã‚Šâ€œæ¸©åº¦â€ã‚’æ±‚ã‚ã¦ã„ã‚‹ã‹ã‚‚ã€‚",
            "ç›¸æ‰‹ã‚ˆã‚Šã‚‚ã€è‡ªåˆ†ã®â€œå—ã‘å–ã‚‹åŠ›â€ãŒãƒ†ãƒ¼ãƒã«ãªã£ã¦ã„ã‚‹å ´åˆã‚‚ã‚ã‚‹ã€‚",
        ],
        "action": [
            "ã‚„ã•ã—ã„ä¸€è¨€ã‚’é€ã‚‹ï¼ˆçŸ­ãã§OKï¼‰ã€‚",
            "è‡ªåˆ†ãŒæ¬²ã—ã„æ„›æƒ…è¡¨ç¾ã‚’1è¡Œã§æ›¸ãï¼ˆè‡ªåˆ†ã‚’ç†è§£ã™ã‚‹ï¼‰ã€‚",
        ],
    },
    "å‘Šç™½ã™ã‚‹/ã•ã‚Œã‚‹": {
        "surface": [
            "æ±ºæ–­ãƒ»å‹‡æ°—ãƒ»ç­”ãˆåˆã‚ã›ã®è±¡å¾´ã€‚é–¢ä¿‚ã®æ¬¡ã®æ®µéšã‚’æœ›ã‚€æ°—æŒã¡ã€‚",
            "è¨€ãˆãªã„æœ¬éŸ³ãŒâ€œå‘Šç™½â€ã¨ã„ã†å½¢ã§å¤¢ã«å‡ºã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚",
        ],
        "deep": [
            "ã€æ‹’å¦ã•ã‚ŒãŸããªã„ã€ã‚ˆã‚Šã€æ›–æ˜§ãªã¾ã¾ãŒæ€–ã„ã€ãŒå¼·ã„ã‚µã‚¤ãƒ³ã‹ã‚‚ã€‚",
            "ç›¸æ‰‹ã¸ã®æƒ³ã„ä»¥ä¸Šã«ã€â€œè‡ªåˆ†ã®æ°—æŒã¡ã‚’ç¢ºã‹ã‚ãŸã„â€æ¬²æ±‚ã®è¡¨ã‚Œã€‚",
        ],
        "action": [
            "ä»Šã®é–¢ä¿‚ã§â€œæœ›ã‚“ã§ã„ã‚‹ã“ã¨â€ã‚’3ã¤æ›¸ãã€‚",
            "å…ˆã«è‡ªåˆ†ã‚’æº€ãŸã™ï¼ˆç¡çœ ãƒ»é£Ÿäº‹ãƒ»ä¼‘æ¯ï¼‰ï¼æ‹æ„›é‹ã®åœŸå°ã€‚",
        ],
    },
    "çµå©š/æŒ‡è¼ª/å¼å ´": {
        "surface": [
            "ç´„æŸãƒ»è¦šæ‚Ÿãƒ»é•·æœŸçš„ãªå®‰å®šã¸ã®æ†§ã‚Œã®è±¡å¾´ã€‚",
            "æ‹æ„›ã ã‘ã§ãªãâ€œäººç”Ÿã‚’æ•´ãˆã‚‹â€æ„è­˜ãŒé«˜ã¾ã‚‹æ™‚æœŸã«å‡ºã‚„ã™ã„ã€‚",
        ],
        "deep": [
            "ç›¸æ‰‹ã‚’æ±‚ã‚ã‚‹ã‚ˆã‚Šã€â€œå®‰å¿ƒã§ãã‚‹æœªæ¥åƒâ€ã‚’æ±‚ã‚ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "ä»Šã®è‡ªåˆ†ã«åˆã†ä¾¡å€¤è¦³ï¼ˆç”Ÿæ´»ãƒ»ãŠé‡‘ãƒ»æ™‚é–“ï¼‰ã®å†è¨­è¨ˆãŒãƒ†ãƒ¼ãƒã‹ã‚‚ã€‚",
        ],
        "action": [
            "ç†æƒ³ã®é–¢ä¿‚ã‚’â€œç”Ÿæ´»ãƒ¬ãƒ™ãƒ«â€ã§1ã¤æ›¸ãï¼ˆä¾‹ï¼šé€±â—¯å›ä¸€ç·’ã«é£Ÿäº‹ï¼‰ã€‚",
            "å°†æ¥ã®ä¸å®‰ã‚’1ã¤ã ã‘â€œå…·ä½“åŒ–â€ã—ã¦å¯¾ç­–æ¡ˆã‚’1è¡Œæ›¸ãã€‚",
        ],
    },
    "å…ƒæ‹äººãŒå‡ºã¦ãã‚‹": {
        "surface": [
            "æœªæ¶ˆåŒ–ã®æ„Ÿæƒ…ã€éå»ã®å­¦ã³ã€æ¯”è¼ƒã®è±¡å¾´ã€‚",
            "ç›¸æ‰‹ãã®ã‚‚ã®ã‚ˆã‚Šâ€œå½“æ™‚ã®è‡ªåˆ†â€ãŒãƒ†ãƒ¼ãƒã«ãªã‚Šã‚„ã™ã„ã€‚",
        ],
        "deep": [
            "ç™’ãˆã¦ã„ãªã„ã¨ã„ã†ã‚ˆã‚Šã€æ¬¡ã«é€²ã‚€ãŸã‚ã®â€œæ•´ç†â€ãŒèµ·ãã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "ã€ã‚‚ã†åŒã˜ç—›ã¿ã¯é¿ã‘ãŸã„ã€ã¨ã„ã†è‡ªå·±é˜²è¡›ãŒåƒã„ã¦ã„ã‚‹ã‹ã‚‚ã€‚",
        ],
        "action": [
            "éå»ã®æ‹ã‹ã‚‰å¾—ãŸâ€œå­¦ã³â€ã‚’1ã¤æ›¸ã„ã¦æ˜‡è¯ã™ã‚‹ã€‚",
            "ä»Šã®è‡ªåˆ†ãŒæœ›ã‚€å¢ƒç•Œç·šï¼ˆå«Œãªã“ã¨ï¼‰ã‚’1ã¤æ±ºã‚ã‚‹ã€‚",
        ],
    },
    "è¿½ã„ã‹ã‘ã‚‹/è¿½ã„ã‹ã‘ã‚‰ã‚Œã‚‹": {
        "surface": [
            "ä¸å®‰ãƒ»åŸ·ç€ãƒ»è·é›¢æ„Ÿã®è±¡å¾´ã€‚æ‹ã®â€œæ¸©åº¦å·®â€ã‚’æ„Ÿã˜ã‚‹æ™‚ã«å‡ºã‚„ã™ã„ã€‚",
            "è¿½ã†ï¼æ±‚ã‚ã‚‹ã€è¿½ã‚ã‚Œã‚‹ï¼æ±‚ã‚ã‚‰ã‚ŒãŸã„ã€ã¨ã„ã†å¿ƒã®å½¢ã€‚",
        ],
        "deep": [
            "å®‰å¿ƒã‚’ç›¸æ‰‹ã«å§”ã­ã™ãã¦ã„ã‚‹å¯èƒ½æ€§ã€‚æ‹æ„›ã®ä¸»å°æ¨©ãŒæºã‚Œã¦ã„ã‚‹ã‹ã‚‚ã€‚",
            "ã€æ„›ã•ã‚Œã‚‹ä¾¡å€¤ãŒã‚ã‚‹ã‹ã€ã‚’è©¦ã—ã¦ã—ã¾ã†ç™–ãŒå‡ºã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "action": [
            "è‡ªåˆ†ã®äºˆå®šã‚’1ã¤å„ªå…ˆã™ã‚‹ï¼ˆæ‹æ„›ã®å‰ã«è‡ªåˆ†ã‚’å°Šé‡ï¼‰ã€‚",
            "â€œä»Šã®ä¸å®‰â€ã‚’è¨€èªåŒ–ã—ã¦ã€äº‹å®Ÿã¨å¦„æƒ³ã‚’åˆ†ã‘ã‚‹ã€‚",
        ],
    },
    "é€£çµ¡ãŒå–ã‚Œãªã„/æ—¢èª­ãŒã¤ã‹ãªã„": {
        "surface": [
            "ä¸å®‰ãƒ»å¾…ã¤æ™‚é–“ãƒ»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ããªã„ã‚‚ã®ã¸ã®è‘›è—¤ã®è±¡å¾´ã€‚",
            "ç›¸æ‰‹ã‚ˆã‚Šã‚‚â€œè‡ªåˆ†ã®å¿ƒã®æºã‚Œâ€ãŒãƒ†ãƒ¼ãƒã«ãªã‚Šã‚„ã™ã„ã€‚",
        ],
        "deep": [
            "ç›¸æ‰‹ã®åå¿œã‚’â€œè‡ªå·±ä¾¡å€¤â€ã¨çµã³ã¤ã‘ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "æœ¬å½“ã¯ã€å®‰å¿ƒã—ãŸã„ã€ã ã‘ã§ã€ç­”ãˆãŒæ¬²ã—ã„ã‚ã‘ã˜ã‚ƒãªã„å ´åˆã‚‚ã€‚",
        ],
        "action": [
            "è¿”ä¿¡ã‚’å¾…ã¤é–“ã«â€œè‡ªåˆ†ã®æº€è¶³â€ã‚’1ã¤å–ã‚‹ï¼ˆæ•£æ­©/é¢¨å‘‚/ä½œæ¥­ï¼‰ã€‚",
            "æ±‚ã‚ã‚‹é »åº¦ã‚„é€£çµ¡ã®ç†æƒ³ã‚’1è¡Œã§æ•´ç†ã™ã‚‹ã€‚",
        ],
    },
    "ä¸€ç·’ã«ç¬‘ã£ã¦ã„ã‚‹/æ¥½ã—ã„ãƒ‡ãƒ¼ãƒˆ": {
        "surface": [
            "å¿ƒãŒé–‹ã„ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚æ„›æƒ…ã‚„ä¿¡é ¼ãŒè‚²ã¤æ–¹å‘æ€§ã€‚",
            "æ‹æ„›é‹ã¨ã„ã†ã‚ˆã‚Šâ€œäººé–“é–¢ä¿‚å…¨ä½“ã®é‹â€ãŒä¸Šå‘ãã“ã¨ã‚‚ã€‚",
        ],
        "deep": [
            "ã€æ°—ã‚’ä½¿ã‚ãªã„é–¢ä¿‚ã€ã¸ã®å¼·ã„é¡˜æœ›ã€‚è‡ªç„¶ä½“ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‚",
            "ç„¡ç†ã‚’ã—ãªã„æ‹ã‚’æœ›ã‚“ã§ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "action": [
            "è‡ªåˆ†ãŒâ€œè‡ªç„¶ä½“ã«ãªã‚Œã‚‹æ¡ä»¶â€ã‚’1ã¤æ›¸ãã€‚",
            "å°ã•ãªã”æ©Ÿå«Œå–ã‚Šã‚’1ã¤ã™ã‚‹ï¼ˆé¦™ã‚Š/æœ/éƒ¨å±‹ï¼‰ã€‚",
        ],
    },
    "æ³£ã/å–§å˜©ã™ã‚‹": {
        "surface": [
            "æ„Ÿæƒ…ã®è§£æ”¾ãƒ»æˆ‘æ…¢ã®é™ç•Œãƒ»æœ¬éŸ³ã®å™´å‡ºã®è±¡å¾´ã€‚",
            "é–¢ä¿‚ã®æ‚ªåŒ–ã¨ã„ã†ã‚ˆã‚Šã€å¿ƒãŒæ•´ç†ã‚’æ±‚ã‚ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚",
        ],
        "deep": [
            "ã€åˆ†ã‹ã£ã¦ã»ã—ã„ã€ãŒæºœã¾ã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "ç›¸æ‰‹ã¨ã„ã†ã‚ˆã‚Šã€è‡ªåˆ†ã®ä¸­ã®â€œè¨±ã›ãªã„ãƒã‚¤ãƒ³ãƒˆâ€ãŒæ˜ç¢ºã«ãªã£ã¦ãã¦ã„ã‚‹ã‹ã‚‚ã€‚",
        ],
        "action": [
            "è‡ªåˆ†ã®æœ¬éŸ³ã‚’â€œè²¬ã‚ãšã«â€1è¡Œã§æ›¸ãï¼ˆä¾‹ï¼šç§ã¯å¯‚ã—ã‹ã£ãŸï¼‰ã€‚",
            "è¨€ã„æ–¹ã‚’æ•´ãˆã‚‹ï¼šä¼ãˆãŸã„ã“ã¨ã‚’çŸ­æ–‡ã«ã™ã‚‹ã€‚",
        ],
    },
}

EMOTIONS = ["å¬‰ã—ã„", "ä¸å®‰", "ç„¦ã‚Š", "æ€–ã„", "å¯‚ã—ã„", "å®‰å¿ƒ", "ãƒ¯ã‚¯ãƒ¯ã‚¯", "æ€’ã‚Š", "ç„¡æ„Ÿæƒ…"]
STATES = ["ç–²ã‚Œã¦ã‚‹", "æŒ‘æˆ¦ä¸­", "åœæ»ãã¿", "å¿™ã—ã„", "çœ ã„", "ãƒ¡ãƒ³ã‚¿ãƒ«ãŒæºã‚Œã‚‹", "é›†ä¸­ã—ãŸã„", "å¤‰ã‚ã‚ŠãŸã„"]


def love_diagnose(sign_key: str, emotion: str, state: str, memo: str) -> str:
    base = LOVE_SIGNS[sign_key]
    surface = random.choice(base["surface"])
    deep = random.choice(base["deep"])
    action = random.choice(base["action"])

    aura = random.choice([
        "æ‹æ„›é‹ã¯â€œç›¸æ‰‹â€ã‚ˆã‚Šå…ˆã«ã€â€œè‡ªåˆ†ã‚’å¤§äº‹ã«ã™ã‚‹åŠ›â€ã§è‚²ã¤ã€‚",
        "æ„›ã¯è¿½ã†ã‚ˆã‚Šã€æ•´ãˆãŸå™¨ã«è‡ªç„¶ã¨æ³¨ãŒã‚Œã‚‹ã€‚",
        "ä¸å®‰ã¯æ•µã˜ã‚ƒãªã„ã€‚é–¢ä¿‚ã‚’è‰¯ãã™ã‚‹ãŸã‚ã®ã‚µã‚¤ãƒ³ã¨ã—ã¦ç¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚",
        "æœ¬å½“ã®é¡˜ã„ã¯ã€å¤¢ã®ä¸­ã§æ­£ç›´ã«å‡ºã¦ãã‚‹ã€‚",
    ])

    hint = ""
    if memo.strip():
        hint = f"ä»Šå›ã®å¤¢ãƒ¡ãƒ¢ï¼šã€{memo.strip()}ã€\n"

    one_line = random.choice([
        "æ„›ã•ã‚Œã‚‹ä¾¡å€¤ã¯ã€æœ€åˆã‹ã‚‰ã‚ã‚‹ã€‚",
        "æ€¥ãŒãªãã¦ã„ã„ã€‚æ•´ã£ãŸé–¢ä¿‚ã¯ã€è‡ªç„¶ã«æ·±ã¾ã‚‹ã€‚",
        "ã‚„ã•ã—ã•ã‚’è‡ªåˆ†ã«ã‚‚å‘ã‘ã‚ˆã†ã€‚",
        "ä»Šæ—¥ã®ä¸€æ­©ãŒã€æœªæ¥ã®å®‰å¿ƒã‚’ä½œã‚‹ã€‚",
    ])

    return (
        f"{hint}"
        f"### ğŸ’ è¡¨ã®æ„å‘³ï¼ˆæ‹æ„›ã‚·ãƒ³ãƒœãƒ«ï¼‰\n"
        f"- {surface}\n\n"
        f"### ğŸŒ‘ è£ã®æ„å‘³ï¼ˆæ·±å±¤ãƒ»å¿ƒã®å‹•ãï¼‰\n"
        f"- {deep}\n\n"
        f"### ğŸ”” æ„Ÿæƒ…Ã—çŠ¶æ…‹ã®ãƒ’ãƒ³ãƒˆ\n"
        f"- æ„Ÿæƒ…ï¼š**{emotion}** ï¼ çŠ¶æ…‹ï¼š**{state}**\n"
        f"- {aura}\n\n"
        f"### âœ… ä»Šæ—¥ã®æ‹æ„›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå°ã•ãï¼‰\n"
        f"- {action}\n\n"
        f"---\n"
        f"**ã²ã¨ã“ã¨**ï¼š{one_line}"
    )


# -------------------------
# UI
# -------------------------
st.set_page_config(page_title=APP_TITLE, layout="centered")
st.title("ğŸ’— æ‹æ„›å¤¢è¨ºæ–­ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼")
st.caption("å¤¢ã‚’â€œæ‹æ„›Ã—å¿ƒç†â€ã§èª­ã¿è§£ãã€‚æŠ•ç¨¿ã«ã‚‚ã©ã†ãã€‚")
st.info(DISCLAIMER)

history = load_history()

st.divider()

col1, col2 = st.columns(2)
with col1:
    sign_key = st.selectbox("å¤¢ã®ã‚·ãƒ¼ãƒ³ï¼ˆé¸æŠï¼‰", list(LOVE_SIGNS.keys()))
with col2:
    emotion = st.selectbox("æ„Ÿæƒ…ï¼ˆä»»æ„ï¼‰", ["ï¼ˆæœªé¸æŠï¼‰"] + EMOTIONS)

state = st.selectbox("æœ€è¿‘ã®çŠ¶æ…‹ï¼ˆä»»æ„ï¼‰", ["ï¼ˆæœªé¸æŠï¼‰"] + STATES)
memo = st.text_area("å¤¢ã®ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰", height=100, placeholder="ä¾‹ï¼šèª°ã‹ã¨æ‰‹ã‚’ã¤ãªã„ã§ã„ãŸï¼é€£çµ¡ãŒè¿”ã£ã¦ã“ãªã‹ã£ãŸâ€¦ãªã©")

st.divider()

if st.button("è¨ºæ–­ã™ã‚‹", use_container_width=True):
    e = emotion if emotion != "ï¼ˆæœªé¸æŠï¼‰" else random.choice(EMOTIONS)
    s = state if state != "ï¼ˆæœªé¸æŠï¼‰" else random.choice(STATES)
    result = love_diagnose(sign_key, e, s, memo)
    st.session_state["result"] = result

if "result" in st.session_state:
    st.subheader("ğŸª„ è¨ºæ–­çµæœ")
    st.markdown(st.session_state["result"])
    st.text_area("ã‚³ãƒ”ãƒšç”¨ï¼ˆMarkdownï¼‰", st.session_state["result"], height=220)

    cA, cB = st.columns(2)
    with cA:
        if st.button("ğŸ’¾ å±¥æ­´ã«ä¿å­˜", use_container_width=True):
            history.append({
                "saved_at": dt.datetime.now().isoformat(timespec="seconds"),
                "sign": sign_key,
                "emotion": emotion,
                "state": state,
                "memo": memo.strip(),
                "result": st.session_state["result"],
            })
            save_history(history)
            st.success("ä¿å­˜ã—ãŸã‚ˆã€‚")
    with cB:
        if st.button("ğŸ§¹ ã‚¯ãƒªã‚¢", use_container_width=True):
            st.session_state.pop("result", None)
            st.rerun()

st.divider()

with st.expander("ğŸ—‚ éå»ã®è¨ºæ–­ï¼ˆæœ€æ–°10ä»¶ï¼‰"):
    if not history:
        st.write("ã¾ã ä¿å­˜ãŒãªã„ã‚ˆã€‚")
    else:
        for row in reversed(history[-10:]):
            st.markdown(f"**{row['saved_at']}ï½œ{row['sign']}ï½œ{row.get('emotion','')}ï½œ{row.get('state','')}**")
            if row.get("memo"):
                st.caption(f"ãƒ¡ãƒ¢ï¼š{row['memo']}")
            st.markdown(row["result"])
            st.write("---")
