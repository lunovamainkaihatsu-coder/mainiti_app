from __future__ import annotations

import json
import random
import datetime as dt
from pathlib import Path

import streamlit as st

APP_TITLE = "ğŸ’° é‡‘é‹å¤¢è¨ºæ–­ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆDay57ï¼‰"

BASE_DIR = Path(__file__).parent
DATA_DIR = BASE_DIR / "data"
DATA_DIR.mkdir(exist_ok=True)
HISTORY_PATH = DATA_DIR / "history.json"

DISCLAIMER = "â€»ã“ã‚Œã¯å‰µä½œçš„ãƒ»å¿ƒç†çš„ãªè§£é‡ˆï¼ˆãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³å«ã‚€ï¼‰ã§ã™ã€‚æŠ•è³‡åŠ©è¨€ãƒ»é‡‘éŠ­ã®ä¿è¨¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"


# -------------------------
# ä¿å­˜/èª­è¾¼
# -------------------------
def load_history():
    if not HISTORY_PATH.exists():
        return []
    try:
        return json.loads(HISTORY_PATH.read_text(encoding="utf-8"))
    except Exception:
        return []


def save_history(rows):
    HISTORY_PATH.write_text(json.dumps(rows, ensure_ascii=False, indent=2), encoding="utf-8")


# -------------------------
# é‡‘é‹å¤¢ã‚·ãƒ³ãƒœãƒ«ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åˆæˆï¼‰
# -------------------------
MONEY_SIGNS = {
    "ãŠé‡‘ã‚’æ‹¾ã†/ã‚‚ã‚‰ã†": {
        "surface": [
            "ãƒãƒ£ãƒ³ã‚¹ã‚„æ©æµã‚’â€œå—ã‘å–ã‚‹æº–å‚™â€ãŒæ•´ã£ã¦ããŸã‚µã‚¤ãƒ³ã€‚",
            "å°ã•ãªå¹¸é‹ã‚„è©•ä¾¡ãŒé›†ã¾ã‚Šå§‹ã‚ã‚‹è±¡å¾´ã¨ã—ã¦å‡ºã‚„ã™ã„å¤¢ã€‚",
        ],
        "deep": [
            "ã€å—ã‘å–ã£ã¦ã„ã„ã€ã¨ã„ã†è¨±å¯ãŒã€å¿ƒã®å¥¥ã§å‡ºå§‹ã‚ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "ãŠé‡‘ãã®ã‚‚ã®ã‚ˆã‚Šâ€œå®‰å¿ƒâ€ã‚„â€œè‡ªç”±â€ã‚’æ±‚ã‚ã¦ã„ã‚‹æ°—æŒã¡ãŒå¼·ã„ã‹ã‚‚ã€‚",
        ],
        "action": [
            "ä»Šæ—¥ã€èª°ã‹ã«ãŠç¤¼ã‚’1å›ä¼ãˆã‚‹ï¼ˆå¾ªç’°ã®ã‚¹ã‚¤ãƒƒãƒï¼‰ã€‚",
            "è‡¨æ™‚åå…¥ã‚ˆã‚Šâ€œå›ºå®šåå…¥ã®ç¨®â€ã‚’1ã¤ãƒ¡ãƒ¢ã™ã‚‹ï¼ˆå•†å“/ã‚¹ã‚­ãƒ«/ç¿’æ…£ï¼‰ã€‚",
        ],
    },
    "è²¡å¸ƒ/ã‚«ãƒãƒ³ã‚’ãªãã™": {
        "surface": [
            "æ”¯å‡ºãƒ»ç®¡ç†ãƒ»ä¿¡é ¼ï¼ˆè‡ªåˆ†/ä»–äººï¼‰ã«æ„è­˜ãŒå‘ã„ã¦ã„ã‚‹è±¡å¾´ã€‚",
            "ã€æ¼ã‚Œã€ã‚„ã€è¦‹è½ã¨ã—ã€ã‚’é˜²ã’ã¨ã„ã†æ³¨æ„å–šèµ·ã¨ã—ã¦å‡ºã‚‹ã“ã¨ã‚‚ã€‚",
        ],
        "deep": [
            "ãŠé‡‘ã®ä¸å®‰ãŒâ€œè‡ªå·±ä¾¡å€¤â€ã¨çµã³ã¤ã„ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "å®ˆã‚Šã«å…¥ã‚Šã™ãã¦ã€é€†ã«ã‚¹ãƒˆãƒ¬ã‚¹ãŒå¢—ãˆã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã‹ã‚‚ã€‚",
        ],
        "action": [
            "ä»Šæœˆã®å›ºå®šè²»ã‚’1ã¤ã ã‘è¦‹ç›´ã™ï¼ˆè§£ç´„å€™è£œã‚’1å€‹å‡ºã™ï¼‰ã€‚",
            "è²¡å¸ƒï¼å¿ƒã®å™¨ï¼šæœºã®ä¸Šã‚’1ã‹æ‰€ã ã‘ç‰‡ã¥ã‘ã‚‹ã€‚",
        ],
    },
    "ãŠé‡‘ã‚’ç›—ã¾ã‚Œã‚‹/å¥ªã‚ã‚Œã‚‹": {
        "surface": [
            "ãƒªã‚½ãƒ¼ã‚¹ï¼ˆæ™‚é–“/ä½“åŠ›/é›†ä¸­ï¼‰ã‚’å¥ªã‚ã‚Œã¦ã„ã‚‹æ„Ÿè¦šã®è±¡å¾´ã€‚",
            "å¢ƒç•Œç·šï¼ˆNOã¨è¨€ã†åŠ›ï¼‰ãŒãƒ†ãƒ¼ãƒã«ãªã‚Šã‚„ã™ã„å¤¢ã€‚",
        ],
        "deep": [
            "ã€é ‘å¼µã‚ŠãŒå ±ã‚ã‚Œãªã„ã€æ€ã„ãŒæºœã¾ã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "ç„¡æ„è­˜ãŒâ€œå®ˆã‚Œâ€ã¨è­¦å‘Šã—ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ï¼ˆæ™‚é–“æ³¥æ£’ã®å­˜åœ¨ãªã©ï¼‰ã€‚",
        ],
        "action": [
            "ä»Šæ—¥ã€æ–­ã‚‹ãƒ»å¾Œå›ã—ã«ã™ã‚‹ã‚’1ã¤æ±ºã‚ã‚‹ã€‚",
            "ä½œæ¥­å‰ã«â€œã‚„ã‚‰ãªã„ã“ã¨â€ã‚’3ã¤æ›¸ã„ã¦ã‹ã‚‰å§‹ã‚ã‚‹ã€‚",
        ],
    },
    "è²·ã„ç‰©ãŒæ­¢ã¾ã‚‰ãªã„/æ•£è²¡ã™ã‚‹": {
        "surface": [
            "æ¬²æ±‚ãƒ»ã‚¹ãƒˆãƒ¬ã‚¹è§£æ¶ˆãƒ»å ±é…¬ä¸è¶³ã®è±¡å¾´ã€‚",
            "å¿ƒã®ç©ºç™½ã‚’åŸ‹ã‚ã‚ˆã†ã¨ã—ã¦ã„ã‚‹æ™‚ã«å‡ºã‚„ã™ã„å¤¢ã€‚",
        ],
        "deep": [
            "ã€é ‘å¼µã£ãŸã®ã«æº€ãŸã•ã‚Œãªã„ã€ã¨ã„ã†ã‚µã‚¤ãƒ³ã‹ã‚‚ã€‚",
            "æ‰¿èªã‚„ä¼‘æ¯ãŒè¶³ã‚Šãšã€ä»£æ›¿ã¨ã—ã¦â€œæ¶ˆè²»â€ãŒå‡ºã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "action": [
            "å…ˆã«ä¼‘ã‚€ï¼ˆ10åˆ†ã ã‘ï¼‰â†’ ãã®å¾Œã«å¿…è¦ãªè²·ã„ç‰©ã ã‘ã™ã‚‹ã€‚",
            "æ¬²ã—ã„ç‰©ã‚’â€œè²·ã†å‰ã«24æ™‚é–“ãƒ¡ãƒ¢â€ã¸ç§»ã™ã€‚",
        ],
    },
    "å®ãã˜/å½“é¸ã™ã‚‹": {
        "surface": [
            "é‹ã®æµã‚Œã¸ã®æœŸå¾…ã€‚æ–°ã—ã„å¯èƒ½æ€§ã‚’æ±‚ã‚ã‚‹ã‚µã‚¤ãƒ³ã€‚",
            "â€œä¸€ç™ºé€†è»¢â€ã‚ˆã‚Šâ€œçªç ´å£â€ã‚’æ¢ã—ã¦ã„ã‚‹å¿ƒã®å‹•ãã€‚",
        ],
        "deep": [
            "ç¾çŠ¶ã‚’å¤‰ãˆãŸã„å¼·ã„æ„å¿—ã®è¡¨ã‚Œã€‚å¤¢ãŒå¸Œæœ›ã‚’è£œçµ¦ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "ã€è‡ªåˆ†ã«ã¯å¯èƒ½æ€§ãŒã‚ã‚‹ã€ã¨ä¿¡ã˜ãŸã„æ°—æŒã¡ãŒè‚²ã£ã¦ã„ã‚‹ã€‚",
        ],
        "action": [
            "å½“é¸ã‚ˆã‚Šç¢ºå®Ÿï¼šåå…¥ã‚’å¢—ã‚„ã™è¡Œå‹•ã‚’1ã¤ã ã‘å®Ÿè¡Œï¼ˆæŠ•ç¨¿/å‡ºå“/å¿œå‹Ÿï¼‰ã€‚",
            "â€œé‹ãŒè‰¯ã‹ã£ãŸã“ã¨â€ã‚’3ã¤æ›¸ã„ã¦è„³ã®ã‚¢ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ã‚‹ã€‚",
        ],
    },
    "é‡‘è²¨/å®ç®±/è²¡å®ã‚’è¦‹ã‚‹": {
        "surface": [
            "ä¾¡å€¤ãƒ»æ‰èƒ½ãƒ»è³‡æºãŒâ€œçœ ã£ã¦ã„ã‚‹â€ã“ã¨ã‚’ç¤ºã™è±¡å¾´ã€‚",
            "ã¾ã ä½¿ã£ã¦ã„ãªã„å¼·ã¿ã‚„ã€æ´»ã‹ã—ãã‚Œã¦ã„ãªã„ã‚¹ã‚­ãƒ«ã®ã‚µã‚¤ãƒ³ã€‚",
        ],
        "deep": [
            "ãŠé‡‘ï¼èƒ½åŠ›ã®äº¤æ›ã€‚è‡ªåˆ†ã®ä¾¡å€¤ã‚’æ­£å½“ã«è¦‹ç©ã‚‚ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ã€‚",
            "ã€å‡ºã—ã¦ã„ã„ã€ã®ã«ã€éš ã—ã¦ã„ã‚‹ã€ä½•ã‹ãŒã‚ã‚‹ã‹ã‚‚ã€‚",
        ],
        "action": [
            "è‡ªåˆ†ã®å¾—æ„ã‚’3ã¤æ›¸ãå‡ºã—ã¦â€œå•†å“åŒ–ã§ãã‚‹å½¢â€ã‚’è€ƒãˆã‚‹ã€‚",
            "ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã«1ã¤è¿½åŠ ï¼ˆGitHub/Note/ä½œå“ï¼‰ã€‚",
        ],
    },
    "ãƒ¬ã‚¸ã§æ‰•ãˆãªã„/ãŠé‡‘ãŒè¶³ã‚Šãªã„": {
        "surface": [
            "ä¸è¶³æ„Ÿï¼ˆè¶³ã‚Šãªã„ï¼‰ãŒãƒ†ãƒ¼ãƒã€‚äºˆç®—ãƒ»æ™‚é–“ãƒ»ä½™è£•ã«é–¢ã™ã‚‹ä¸å®‰ã®è±¡å¾´ã€‚",
            "ä»Šã®è¨ˆç”»ãŒâ€œç››ã‚Šã™ãâ€ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ã‚‚ç¤ºã™ã€‚",
        ],
        "deep": [
            "ãŠé‡‘ã®ä¸å®‰ãŒã€æœªæ¥ã®ä¸å®‰ã«ç›´çµã—ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚",
            "ã€è‡ªåˆ†ã«ã¯ç„¡ç†ã€ã¨ã„ã†æ€ã„è¾¼ã¿ã‚’ã€å¤¢ãŒè¦‹ã›ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "action": [
            "ä»Šæ—¥ã®ç›®æ¨™ã‚’åŠåˆ†ã«ã™ã‚‹ï¼ˆé”æˆä½“é¨“ã‚’ä½œã‚‹ï¼‰ã€‚",
            "å›ºå®šè²»ã‚ˆã‚Šå…ˆã«â€œç¨¼ãè¡Œå‹•â€ã‚’5åˆ†ã ã‘ã‚„ã‚‹ï¼ˆæŠ•ç¨¿/ä½œæ¥­/ç™ºä¿¡ï¼‰ã€‚",
        ],
    },
    "ATM/é€šå¸³/æ®‹é«˜ã‚’è¦‹ã‚‹": {
        "surface": [
            "ç¾å®Ÿã¨å‘ãåˆã†åŠ›ãŒä¸ŠãŒã£ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚ç®¡ç†ï¼å®‰å®šã®è±¡å¾´ã€‚",
            "æ•°å­—ã¸ã®æã‚ŒãŒã‚ã‚‹æ™‚ã«ã‚‚å‡ºã‚„ã™ã„å¤¢ã€‚",
        ],
        "deep": [
            "ã€è¦‹ãŸããªã„ã€ã¨ã€æŠŠæ¡ã—ãŸã„ã€ãŒåŒå±…ã—ã¦ã„ã‚‹çŠ¶æ…‹ã‹ã‚‚ã€‚",
            "ãŠé‡‘ï¼å®‰å¿ƒã‚’ã€å°‘ã—ãšã¤å–ã‚Šæˆ»ã—ãŸã„æ°—æŒã¡ã®è¡¨ã‚Œã€‚",
        ],
        "action": [
            "å®¶è¨ˆã‚’â€œè¦‹ã‚‹ã ã‘â€ã§OKï¼šæ”¯å‡ºã‚’1ã‚«ãƒ†ã‚´ãƒªã ã‘ç¢ºèªã™ã‚‹ã€‚",
            "åå…¥ã‚’å¢—ã‚„ã™â€œæ¬¡ã®ä¸€æ‰‹â€ã‚’1è¡Œã§æ±ºã‚ã‚‹ã€‚",
        ],
    },
}

EMOTIONS = ["å¬‰ã—ã„", "ä¸å®‰", "ç„¦ã‚Š", "æ€–ã„", "æ‚”ã—ã„", "å®‰å¿ƒ", "ãƒ¯ã‚¯ãƒ¯ã‚¯", "ç„¡æ„Ÿæƒ…"]
STATES = ["ç–²ã‚Œã¦ã‚‹", "æŒ‘æˆ¦ä¸­", "åœæ»ãã¿", "å¿™ã—ã„", "çœ ã„", "ãƒ¡ãƒ³ã‚¿ãƒ«ãŒæºã‚Œã‚‹", "é›†ä¸­ã—ãŸã„", "å¤‰ã‚ã‚ŠãŸã„"]


def money_diagnose(sign_key: str, emotion: str, state: str, memo: str) -> str:
    base = MONEY_SIGNS[sign_key]
    surface = random.choice(base["surface"])
    deep = random.choice(base["deep"])
    action = random.choice(base["action"])

    # â€œé‡‘é‹ã£ã½ã„â€ä½™éŸ»
    aura = random.choice([
        "ãŠé‡‘ã¯â€œæ€–ã„ã‚‚ã®â€ã˜ã‚ƒãªãã¦ã€é¸æŠè‚¢ã‚’å¢—ã‚„ã™é“å…·ã€‚",
        "é‡‘é‹ã¯é‹ã ã‘ã˜ã‚ƒãªãã€ç¿’æ…£ã¨è¦–ç‚¹ã§è‚²ã¤ã€‚",
        "å—ã‘å–ã‚‹å™¨ãŒæ•´ã†ã¨ã€æµã‚Œã¯è‡ªç„¶ã«å…¥ã£ã¦ãã‚‹ã€‚",
        "å°ã•ãªå‹ã¡ãŒç¶šãã¨ã€ç¾å®Ÿã¯æ€¥ã«å¤‰ã‚ã‚‹ã€‚",
    ])

    hint = ""
    if memo.strip():
        hint = f"ä»Šå›ã®å¤¢ãƒ¡ãƒ¢ï¼šã€{memo.strip()}ã€\n"

    one_line = random.choice([
        "ä»Šæ—¥ã®1æ­©ãŒã€æ¥æœˆã®å®‰å¿ƒã‚’ä½œã‚‹ã€‚",
        "ãŠé‡‘ã¯è¿½ã†ã‚ˆã‚Šã€æ•´ãˆã‚‹ã¨å¯„ã£ã¦ãã‚‹ã€‚",
        "å°ã•ãç¨¼ã â†’ å°ã•ãå®ˆã‚‹ â†’ ã¾ãŸå¢—ã‚„ã™ã€‚",
        "ã€ã§ããŸã€ã‚’å¢—ã‚„ã™ã»ã©ã€é‡‘é‹ã¯å®‰å®šã™ã‚‹ã€‚",
    ])

    return (
        f"{hint}"
        f"### ğŸŒ• è¡¨ã®æ„å‘³ï¼ˆé‡‘é‹ã‚·ãƒ³ãƒœãƒ«ï¼‰\n"
        f"- {surface}\n\n"
        f"### ğŸŒ‘ è£ã®æ„å‘³ï¼ˆæ·±å±¤ãƒ»ãŠé‡‘ã®æ„Ÿæƒ…ï¼‰\n"
        f"- {deep}\n\n"
        f"### ğŸ”” æ„Ÿæƒ…Ã—çŠ¶æ…‹ã®ãƒ’ãƒ³ãƒˆ\n"
        f"- æ„Ÿæƒ…ï¼š**{emotion}** ï¼ çŠ¶æ…‹ï¼š**{state}**\n"
        f"- {aura}\n\n"
        f"### âœ… ä»Šæ—¥ã®é‡‘é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå°ã•ãï¼‰\n"
        f"- {action}\n\n"
        f"---\n"
        f"**ã²ã¨ã“ã¨**ï¼š{one_line}"
    )


# -------------------------
# UI
# -------------------------
st.set_page_config(page_title=APP_TITLE, layout="centered")
st.title("ğŸ’° é‡‘é‹å¤¢è¨ºæ–­ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼")
st.caption("å¤¢ã‚’â€œé‡‘é‹Ã—å¿ƒç†â€ã§èª­ã¿è§£ãã€‚æŠ•ç¨¿ã«ã‚‚ã©ã†ãã€‚")
st.info(DISCLAIMER)

history = load_history()

st.divider()

col1, col2 = st.columns(2)
with col1:
    sign_key = st.selectbox("å¤¢ã®ã‚·ãƒ¼ãƒ³ï¼ˆé¸æŠï¼‰", list(MONEY_SIGNS.keys()))
with col2:
    emotion = st.selectbox("æ„Ÿæƒ…ï¼ˆä»»æ„ï¼‰", ["ï¼ˆæœªé¸æŠï¼‰"] + EMOTIONS)

state = st.selectbox("æœ€è¿‘ã®çŠ¶æ…‹ï¼ˆä»»æ„ï¼‰", ["ï¼ˆæœªé¸æŠï¼‰"] + STATES)
memo = st.text_area("å¤¢ã®ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰", height=100, placeholder="ä¾‹ï¼šè²¡å¸ƒã‚’è½ã¨ã—ãŸï¼ATMã§æ®‹é«˜ã‚’è¦‹ã¦ã„ãŸâ€¦ãªã©")

st.divider()

if st.button("è¨ºæ–­ã™ã‚‹", use_container_width=True):
    e = emotion if emotion != "ï¼ˆæœªé¸æŠï¼‰" else random.choice(EMOTIONS)
    s = state if state != "ï¼ˆæœªé¸æŠï¼‰" else random.choice(STATES)
    result = money_diagnose(sign_key, e, s, memo)
    st.session_state["result"] = result

if "result" in st.session_state:
    st.subheader("ğŸª„ è¨ºæ–­çµæœ")
    st.markdown(st.session_state["result"])
    st.text_area("ã‚³ãƒ”ãƒšç”¨ï¼ˆMarkdownï¼‰", st.session_state["result"], height=220)

    cA, cB = st.columns(2)
    with cA:
        if st.button("ğŸ’¾ å±¥æ­´ã«ä¿å­˜", use_container_width=True):
            history.append({
                "saved_at": dt.datetime.now().isoformat(timespec="seconds"),
                "sign": sign_key,
                "emotion": emotion,
                "state": state,
                "memo": memo.strip(),
                "result": st.session_state["result"],
            })
            save_history(history)
            st.success("ä¿å­˜ã—ãŸã‚ˆã€‚")
    with cB:
        if st.button("ğŸ§¹ ã‚¯ãƒªã‚¢", use_container_width=True):
            st.session_state.pop("result", None)
            st.rerun()

st.divider()

with st.expander("ğŸ—‚ éå»ã®è¨ºæ–­ï¼ˆæœ€æ–°10ä»¶ï¼‰"):
    if not history:
        st.write("ã¾ã ä¿å­˜ãŒãªã„ã‚ˆã€‚")
    else:
        for row in reversed(history[-10:]):
            st.markdown(f"**{row['saved_at']}ï½œ{row['sign']}ï½œ{row.get('emotion','')}ï½œ{row.get('state','')}**")
            if row.get("memo"):
                st.caption(f"ãƒ¡ãƒ¢ï¼š{row['memo']}")
            st.markdown(row["result"])
            st.write("---")
