from __future__ import annotations

import json
import random
import datetime as dt
from pathlib import Path

import streamlit as st

APP_TITLE = "ğŸŒ™ å¤¢è¨ºæ–­ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆDay56ï¼‰"

BASE_DIR = Path(__file__).parent
DATA_DIR = BASE_DIR / "data"
DATA_DIR.mkdir(exist_ok=True)
HISTORY_PATH = DATA_DIR / "history.json"

DISCLAIMER = "â€»ã“ã‚Œã¯å‰µä½œçš„ãƒ»å¿ƒç†çš„ãªè§£é‡ˆï¼ˆãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³å«ã‚€ï¼‰ã§ã™ã€‚åŒ»ç™‚çš„ãªè¨ºæ–­ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"


# -------------------------
# ä¿å­˜/èª­è¾¼
# -------------------------
def load_history():
    if not HISTORY_PATH.exists():
        return []
    try:
        return json.loads(HISTORY_PATH.read_text(encoding="utf-8"))
    except Exception:
        return []


def save_history(rows):
    HISTORY_PATH.write_text(json.dumps(rows, ensure_ascii=False, indent=2), encoding="utf-8")


# -------------------------
# è¨ºæ–­ç´ æï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åˆæˆï¼‰
# -------------------------
DREAM_SIGNS = {
    "è½ã¡ã‚‹ï¼ˆé«˜ã„æ‰€ã‹ã‚‰ï¼‰": {
        "surface": [
            "ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å¤±ã†ã“ã¨ã¸ã®ä¸å®‰ã€åœ°ã«è¶³ãŒã¤ã‹ãªã„æ„Ÿè¦šã®è±¡å¾´ã€‚",
            "äºˆå®šã‚„è¨ˆç”»ãŒå´©ã‚Œã‚‹ã“ã¨ã¸ã®è­¦æˆ’å¿ƒãŒè¡¨ã‚Œã‚„ã™ã„ã‚µã‚¤ãƒ³ã€‚",
        ],
        "deep": [
            "ã€å¤±æ•—ã—ãŸããªã„ã€ã‚ˆã‚Šã‚‚ã€å¤±æœ›ã•ã‚ŒãŸããªã„ã€ãŒå¼·ãå‡ºã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "å®‰å¿ƒã§ãã‚‹åœŸå°ï¼ˆç”Ÿæ´»ãƒ»ãŠé‡‘ãƒ»äººé–“é–¢ä¿‚ï¼‰ã‚’æ±‚ã‚ã‚‹å¿ƒã®å‹•ãã€‚",
        ],
        "action": [
            "ä»Šæ—¥ã®æœ€å°ã‚¿ã‚¹ã‚¯ã‚’1ã¤ã ã‘æ±ºã‚ã¦å®Œäº†ã™ã‚‹ã€‚",
            "ã€æœ€æ‚ªã“ã†ãªã£ã¦ã‚‚ç”Ÿãæ®‹ã‚Œã‚‹ã€ãƒ—ãƒ©ãƒ³ã‚’1è¡Œæ›¸ãã€‚",
        ],
    },
    "è¿½ã‚ã‚Œã‚‹ï¼ˆèª°ã‹/ä½•ã‹ã«ï¼‰": {
        "surface": [
            "å‘ãåˆã„ãŸããªã„èª²é¡Œã‚„ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚’ã€è¿½è·¡è€…ã€ã¨ã—ã¦å¤¢ãŒè¡¨ç¾ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚",
            "ç„¦ã‚Šã‚„ç· åˆ‡ã€è²¬ä»»æ„ŸãŒå¼·ã„ã¨å‡ºã‚„ã™ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚",
        ],
        "deep": [
            "æœ¬å½“ã¯ä¼‘ã¿ãŸã„ã®ã«ã€ä¼‘ã‚€ã“ã¨ã«ç½ªæ‚ªæ„ŸãŒã‚ã‚‹ã‚µã‚¤ãƒ³ã‹ã‚‚ã€‚",
            "ã€ã‚„ã‚‹ã¹ãã€ãŒå¢—ãˆã™ãã¦ã€è‡ªåˆ†ã®å£°ãŒç½®ãå»ã‚Šã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "action": [
            "ã‚¿ã‚¹ã‚¯ã‚’â€œæ¨ã¦ã‚‹/å»¶æœŸã™ã‚‹â€ã‚’1ã¤æ±ºã‚ã‚‹ã€‚",
            "ã€ä»Šã„ã¡ã°ã‚“æ€–ã„ã“ã¨ã€ã‚’1è¡Œã ã‘è¨€èªåŒ–ã™ã‚‹ã€‚",
        ],
    },
    "æ­¯ãŒæŠœã‘ã‚‹/ãƒœãƒ­ãƒœãƒ­": {
        "surface": [
            "è‡ªå·±è©•ä¾¡ãƒ»è¦‹ãŸç›®ãƒ»è¨€è‘‰ï¼ˆç™ºä¿¡ï¼‰ã¸ã®ä¸å®‰ãŒåæ˜ ã•ã‚Œã‚„ã™ã„è±¡å¾´ã€‚",
            "ä½“åŠ›ä½ä¸‹ã‚„ã‚¹ãƒˆãƒ¬ã‚¹ãŒç¶šãã¨å‡ºã‚„ã™ã„ã¨ã„ã‚ã‚Œã‚‹å®šç•ªå¤¢ã€‚",
        ],
        "deep": [
            "ã€ã¡ã‚ƒã‚“ã¨ã—ãŸã„ã€æ°—æŒã¡ãŒå¼·ã„ã»ã©ã€æ¬ ã‘ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§å‡ºã¦ãã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚",
            "äººå‰ã§ã®è©•ä¾¡ã‚ˆã‚Šã€â€œè‡ªåˆ†ã«å¯¾ã™ã‚‹æ¡ç‚¹â€ãŒå³ã—ããªã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "action": [
            "å®Œç’§ã˜ã‚ƒãªãã¦ã„ã„æˆæœç‰©ã‚’1ã¤å‡ºã™ï¼ˆ60ç‚¹ã§OKï¼‰ã€‚",
            "ä½“èª¿ç³»ã®ã‚±ã‚¢ï¼ˆç¡çœ /æ°´åˆ†/è»½ã„ã‚¹ãƒˆãƒ¬ãƒƒãƒï¼‰ã‚’å„ªå…ˆã™ã‚‹ã€‚",
        ],
    },
    "çŸ¥ã‚‰ãªã„å®¶/éƒ¨å±‹ã«ã„ã‚‹": {
        "surface": [
            "æœªé–‹æ‹“ã®è‡ªåˆ†ã€ã¾ã ä½¿ã£ã¦ã„ãªã„æ‰èƒ½ã‚„é ˜åŸŸã®è±¡å¾´ã€‚",
            "ç’°å¢ƒå¤‰åŒ–ãƒ»å¼•ã£è¶Šã—ãƒ»æ–°ã—ã„æŒ‘æˆ¦ãŒè¿‘ã„æ™‚ã«å‡ºã‚‹ã“ã¨ã‚‚ã€‚",
        ],
        "deep": [
            "ã€è‡ªåˆ†ã§ã‚‚çŸ¥ã‚‰ãªã„æœ›ã¿ã€ãŒå¥¥ã«ã‚ã‚‹ã‚µã‚¤ãƒ³ã€‚ãƒ¯ã‚¯ãƒ¯ã‚¯ã¨ä¸å®‰ãŒæ··ã–ã‚‹ã€‚",
            "â€œæ–°ã—ã„è‡ªåˆ†â€ã¸ç§»è¡Œä¸­ã§ã€å¤ã„è‡ªåˆ†ã®æ®»ãŒåˆã‚ãªããªã£ã¦ãã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "action": [
            "ã‚„ã‚ŠãŸã„ã“ã¨ã‚’3ã¤ã ã‘ç®‡æ¡æ›¸ãã™ã‚‹ã€‚",
            "éƒ¨å±‹ï¼ˆç¾å®Ÿï¼‰ã‚’1ã‹æ‰€ã ã‘æ•´ãˆã¦â€œå™¨â€ã‚’ä½œã‚‹ã€‚",
        ],
    },
    "é…åˆ»/é–“ã«åˆã‚ãªã„": {
        "surface": [
            "æœŸå¾…ãƒ»ç„¦ã‚Šãƒ»è²¬ä»»æ„Ÿã®è±¡å¾´ã€‚ã€é–“ã«åˆã‚ã›ãŸã„ã€ãŒå¼·ã„ã»ã©å‡ºã‚„ã™ã„ã€‚",
            "æº–å‚™ä¸è¶³ã¸ã®ä¸å®‰ã¨ã„ã†ã‚ˆã‚Šã€æ™‚é–“ã®åœ§è¿«æ„ŸãŒè¡¨ç¾ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã€‚",
        ],
        "deep": [
            "ã€æ—©ãçµæœã‚’å‡ºã•ãªã„ã¨ã€ã¨ã„ã†å†…åœ§ãŒé«˜ã„ã‚µã‚¤ãƒ³ã€‚",
            "ä»–äººã®æœŸå¾…ã‚ˆã‚Šã€è‡ªåˆ†ã®ç†æƒ³åƒã«è¿½ã„ã¤ã“ã†ã¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "action": [
            "â€œä»Šæ—¥ã‚„ã‚‰ãªã„ã“ã¨â€ã‚’1ã¤æ±ºã‚ã¦æ¨ã¦ã‚‹ã€‚",
            "ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã«æˆ»ã£ã¦ã€æœ€åˆã®1æ­©ã ã‘ã‚„ã‚‹ï¼ˆ5åˆ†ã§OKï¼‰ã€‚",
        ],
    },
    "è©¦é¨“/ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã‚‹": {
        "surface": [
            "è©•ä¾¡ã•ã‚Œã‚‹å ´é¢ã¸ã®æ„è­˜ã€‚å®ŸåŠ›ã‚ˆã‚Šã‚‚â€œæº–å‚™æ„Ÿâ€ãŒãƒ†ãƒ¼ãƒã«ãªã‚Šã‚„ã™ã„ã€‚",
            "æŒ‘æˆ¦ä¸­ãƒ»æˆé•·æœŸã«å‡ºã‚„ã™ã„å¤¢ã®ã²ã¨ã¤ã€‚",
        ],
        "deep": [
            "ã€ã¾ã è¶³ã‚Šãªã„ã€ã¨æ„Ÿã˜ã¦ã„ã‚‹ã‘ã©ã€å®Ÿã¯ä¼¸ã³ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚",
            "éå»ã®çµŒé¨“ï¼ˆå¤±æ•—/æˆåŠŸï¼‰ã®è¨˜æ†¶ãŒã€ä»Šã®æŒ‘æˆ¦ã«é‡ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "action": [
            "ä»Šæ—¥ã®å­¦ç¿’ã‚’â€œ1ãƒšãƒ¼ã‚¸/1å•â€ã ã‘ã‚„ã‚‹ã€‚",
            "ã‚„ã£ãŸå†…å®¹ã‚’1è¡Œã§è¨˜éŒ²ã—ã¦è‡ªå·±åŠ¹åŠ›æ„Ÿã‚’ç©ã‚€ã€‚",
        ],
    },
    "èª°ã‹ãŒç„¡è¨€ã§è¦‹ã¦ãã‚‹": {
        "surface": [
            "è¦–ç·šï¼è©•ä¾¡ãƒ»æ°—é…ï¼ä¸å®‰ã®è±¡å¾´ã€‚æ°—ã«ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚‹æ™‚ã«å‡ºã‚„ã™ã„ã€‚",
            "è¨€è‘‰ã«ãªã‚‰ãªã„æ„Ÿæƒ…ï¼ˆãƒ¢ãƒ¤ãƒ¢ãƒ¤ï¼‰ãŒâ€œç„¡è¨€ã®å­˜åœ¨â€ã¨ã—ã¦ç¾ã‚Œã‚‹ã“ã¨ã‚‚ã€‚",
        ],
        "deep": [
            "æœ¬å½“ã¯è¨€ã„ãŸã„ã“ã¨ãŒã‚ã‚‹ã®ã«é£²ã¿è¾¼ã‚“ã§ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "ã€ç†è§£ã•ã‚ŒãŸã„ã€ã¨ã€ä¸€äººã§æŠ±ãˆãŸã„ã€ãŒåŒå±…ã—ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚",
        ],
        "action": [
            "è¨€ã„ã«ãã„æœ¬éŸ³ã‚’1è¡Œã ã‘ãƒ¡ãƒ¢ã«åãå‡ºã™ï¼ˆèª°ã«ã‚‚è¦‹ã›ãªã„ï¼‰ã€‚",
            "SNSã‚„æƒ…å ±ã‚’5åˆ†ã ã‘é®æ–­ã—ã¦é™ã‹ã«å‘¼å¸ã™ã‚‹ã€‚",
        ],
    },
}

EMOTIONS = ["æ€–ã„", "ä¸å®‰", "ç„¦ã‚Š", "æ‚²ã—ã„", "æ€’ã‚Š", "æ‡ã‹ã—ã„", "å®‰å¿ƒ", "ãƒ¯ã‚¯ãƒ¯ã‚¯", "ç„¡æ„Ÿæƒ…"]
STATES = ["ç–²ã‚Œã¦ã‚‹", "æŒ‘æˆ¦ä¸­", "åœæ»ãã¿", "å¿™ã—ã„", "çœ ã„", "ãƒ¡ãƒ³ã‚¿ãƒ«ãŒæºã‚Œã‚‹", "é›†ä¸­ã—ãŸã„", "å¤‰ã‚ã‚ŠãŸã„"]


def blend_text(sign_key: str, emotion: str, state: str, free_text: str) -> str:
    base = DREAM_SIGNS[sign_key]
    surface = random.choice(base["surface"])
    deep = random.choice(base["deep"])
    action = random.choice(base["action"])

    # æ¼”å‡ºï¼ˆã‚ªã‚«ãƒ«ãƒˆé¢¨ã®â€œä½™éŸ»â€ï¼‰
    aura = random.choice([
        "æœˆæ˜ã‹ã‚Šã®ä¸‹ã§ã€ç„¡æ„è­˜ã¯ã‚ˆãå–‹ã‚‹ã€‚",
        "å¤¢ã¯æœªæ¥äºˆçŸ¥ã˜ã‚ƒãªã„ã€‚ã‘ã©ã€å¿ƒã®æ–¹å‘ã¯æ˜ ã™ã€‚",
        "æ€–ã•ã¯è­¦å ±ã§ã€ã‚ãªãŸã‚’å®ˆã‚‹ãŸã‚ã«é³´ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚",
        "ä»Šã®ã‚ãªãŸã¯â€œå¤‰åŒ–ã®æ‰‹å‰â€ã«ã„ã‚‹ã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚",
    ])

    # è‡ªç”±å…¥åŠ›ãŒã‚ã‚‹å ´åˆã€å°‘ã—ã ã‘æ··ãœã‚‹
    hint = ""
    if free_text.strip():
        hint = f"ä»Šå›ã®å¤¢ã®ãƒ¡ãƒ¢ï¼šã€{free_text.strip()}ã€\n"

    text = (
        f"{hint}"
        f"### ğŸŒ’ è¡¨ã®æ„å‘³ï¼ˆè±¡å¾´ï¼‰\n"
        f"- {surface}\n\n"
        f"### ğŸŒ‘ è£ã®æ„å‘³ï¼ˆæ·±å±¤ï¼‰\n"
        f"- {deep}\n\n"
        f"### ğŸ”” ä»Šã®æ„Ÿæƒ…Ã—çŠ¶æ…‹ã®ãƒ’ãƒ³ãƒˆ\n"
        f"- æ„Ÿæƒ…ï¼š**{emotion}** ï¼ çŠ¶æ…‹ï¼š**{state}**\n"
        f"- {aura}\n\n"
        f"### âœ… ä»Šæ—¥ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå°ã•ãï¼‰\n"
        f"- {action}\n\n"
        f"---\n"
        f"**ã²ã¨ã“ã¨**ï¼š{random.choice(['å¤§ä¸ˆå¤«ã€æ•´ãˆã¦ã„ã‘ã‚‹ã€‚', 'å°ã•ãå‹•ã‘ã°ã€ç¾å®Ÿã¯è¿½ã„ã¤ãã€‚', 'ä»Šæ—¥ã®1æ­©ãŒã€å¤¢ã‚’ç¾å®Ÿã«å¯„ã›ã‚‹ã€‚'])}"
    )
    return text


# -------------------------
# UI
# -------------------------
st.set_page_config(page_title=APP_TITLE, layout="centered")
st.title("ğŸŒ™ å¤¢è¨ºæ–­ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼")
st.caption("å¤¢ã‚’â€œã‚ªã‚«ãƒ«ãƒˆé¢¨â€ã«ã€ã§ã‚‚å¿ƒç†å¯„ã‚Šã§å®‰å…¨ã«è§£é‡ˆã™ã‚‹ã€‚æŠ•ç¨¿ã«ã‚‚ã©ã†ãã€‚")
st.info(DISCLAIMER)

history = load_history()

st.divider()

col1, col2 = st.columns(2)
with col1:
    sign_key = st.selectbox("å¤¢ã®ã‚·ãƒ¼ãƒ³ï¼ˆé¸æŠï¼‰", list(DREAM_SIGNS.keys()))
with col2:
    emotion = st.selectbox("æ„Ÿæƒ…ï¼ˆä»»æ„ï¼‰", ["ï¼ˆæœªé¸æŠï¼‰"] + EMOTIONS)

state = st.selectbox("æœ€è¿‘ã®çŠ¶æ…‹ï¼ˆä»»æ„ï¼‰", ["ï¼ˆæœªé¸æŠï¼‰"] + STATES)

free_text = st.text_area("å¤¢ã®ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰", height=100, placeholder="ä¾‹ï¼šæš—ã„å»Šä¸‹ã§éµã‚’æ¢ã—ã¦ãŸï¼èª°ã‹ã®å£°ãŒã—ãŸâ€¦ãªã©")

st.divider()

if st.button("è¨ºæ–­ã™ã‚‹", use_container_width=True):
    e = emotion if emotion != "ï¼ˆæœªé¸æŠï¼‰" else random.choice(EMOTIONS)
    s = state if state != "ï¼ˆæœªé¸æŠï¼‰" else random.choice(STATES)
    result = blend_text(sign_key, e, s, free_text)
    st.session_state["result"] = result

if "result" in st.session_state:
    st.subheader("ğŸª„ è¨ºæ–­çµæœ")
    st.markdown(st.session_state["result"])

    st.text_area("ã‚³ãƒ”ãƒšç”¨ï¼ˆMarkdownï¼‰", st.session_state["result"], height=220)

    cA, cB = st.columns(2)
    with cA:
        if st.button("ğŸ’¾ å±¥æ­´ã«ä¿å­˜", use_container_width=True):
            history.append({
                "saved_at": dt.datetime.now().isoformat(timespec="seconds"),
                "sign": sign_key,
                "emotion": emotion,
                "state": state,
                "memo": free_text.strip(),
                "result": st.session_state["result"],
            })
            save_history(history)
            st.success("ä¿å­˜ã—ãŸã‚ˆã€‚")
    with cB:
        if st.button("ğŸ§¹ ã‚¯ãƒªã‚¢", use_container_width=True):
            st.session_state.pop("result", None)
            st.rerun()

st.divider()

with st.expander("ğŸ—‚ éå»ã®è¨ºæ–­ï¼ˆæœ€æ–°10ä»¶ï¼‰"):
    if not history:
        st.write("ã¾ã ä¿å­˜ãŒãªã„ã‚ˆã€‚")
    else:
        for row in reversed(history[-10:]):
            st.markdown(
                f"**{row['saved_at']}ï½œ{row['sign']}ï½œ{row.get('emotion','')}ï½œ{row.get('state','')}**"
            )
            if row.get("memo"):
                st.caption(f"ãƒ¡ãƒ¢ï¼š{row['memo']}")
            st.markdown(row["result"])
            st.write("---")
