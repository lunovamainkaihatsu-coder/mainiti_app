from __future__ import annotations

import json
import random
import datetime as dt
from pathlib import Path

import streamlit as st

APP_TITLE = "ğŸ§  ä»•äº‹é‹å¤¢è¨ºæ–­ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆDay59ï¼‰"

BASE_DIR = Path(__file__).parent
DATA_DIR = BASE_DIR / "data"
DATA_DIR.mkdir(exist_ok=True)
HISTORY_PATH = DATA_DIR / "history.json"

DISCLAIMER = "â€»ã“ã‚Œã¯å‰µä½œçš„ãƒ»å¿ƒç†çš„ãªè§£é‡ˆï¼ˆãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³å«ã‚€ï¼‰ã§ã™ã€‚è·æ¥­ãƒ»è©•ä¾¡ãƒ»çµæœã®ä¿è¨¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"


# -------------------------
# ä¿å­˜/èª­è¾¼
# -------------------------
def load_history():
    if not HISTORY_PATH.exists():
        return []
    try:
        return json.loads(HISTORY_PATH.read_text(encoding="utf-8"))
    except Exception:
        return []


def save_history(rows):
    HISTORY_PATH.write_text(json.dumps(rows, ensure_ascii=False, indent=2), encoding="utf-8")


# -------------------------
# ä»•äº‹é‹å¤¢ã‚·ãƒ³ãƒœãƒ«ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åˆæˆï¼‰
# -------------------------
WORK_SIGNS = {
    "é…åˆ»/é–“ã«åˆã‚ãªã„ï¼ˆä»•äº‹ãƒ»ä¼šè­°ï¼‰": {
        "surface": [
            "ç„¦ã‚Šãƒ»æœŸå¾…ãƒ»è²¬ä»»æ„Ÿã®è±¡å¾´ã€‚ã€é–“ã«åˆã‚ã›ãŸã„ã€ãŒå¼·ã„ã»ã©å‡ºã‚„ã™ã„ã€‚",
            "ä»•äº‹ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒå¤šãã€å¿ƒãŒâ€œç· åˆ‡åœ§â€ã‚’æ„Ÿã˜ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚",
        ],
        "deep": [
            "å®ŸåŠ›ä¸è¶³ã‚ˆã‚Šã€ä½™è£•ã®ä¸è¶³ã€ãŒãƒ†ãƒ¼ãƒã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "â€œå®Œç’§ã«ã‚„ã‚ŠãŸã„â€æ°—æŒã¡ãŒè‡ªåˆ†ã‚’è¿½ã„è¾¼ã‚“ã§ã„ã‚‹ã‹ã‚‚ã€‚",
        ],
        "action": [
            "ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’1ã¤ã ã‘â€œæœ€å„ªå…ˆâ€ã«ã—ã¦ä»–ã‚’æ¨ã¦ã‚‹ã€‚",
            "ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æ—©ã‚ã‚‹ã‚ˆã‚Šâ€œã‚„ã‚‹é‡â€ã‚’åŠåˆ†ã«ã—ã¦æˆåŠŸä½“é¨“ã‚’å–ã‚‹ã€‚",
        ],
    },
    "è³‡æ–™/æ›¸é¡ãŒè¦‹ã¤ã‹ã‚‰ãªã„": {
        "surface": [
            "æº–å‚™ãƒ»æ®µå–ã‚Šãƒ»æ•´ç†ã®è±¡å¾´ã€‚æƒ…å ±ãŒæ•£ã‚‰ã‹ã£ã¦ã„ã‚‹æ™‚ã«å‡ºã‚„ã™ã„ã€‚",
            "ä»•äº‹ã®å„ªå…ˆé †ä½ãŒæ›–æ˜§ã«ãªã£ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã®ã“ã¨ã‚‚ã€‚",
        ],
        "deep": [
            "ã€ã¡ã‚ƒã‚“ã¨ã—ãŸã„ã€æ°—æŒã¡ãŒå¼·ã„ã»ã©ã€æŠœã‘è½ã¡ã‚‹å¤¢ã§è­¦æˆ’ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚",
            "é ­ã®ä¸­ã®ã‚¿ãƒ–ãŒé–‹ãã™ãã¦ã„ã‚‹å¯èƒ½æ€§ï¼ˆæƒ…å ±éå¤šï¼‰ã€‚",
        ],
        "action": [
            "æœº/PCã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’1ã‹æ‰€ã ã‘æ•´ãˆã‚‹ã€‚",
            "ä»Šæ—¥ã®ToDoã‚’3ã¤ã«çµã‚‹ï¼ˆãã‚Œä»¥ä¸Šã¯æ˜æ—¥ã«å›ã™ï¼‰ã€‚",
        ],
    },
    "ä¸Šå¸/å…ˆç”Ÿã«æ€’ã‚‰ã‚Œã‚‹": {
        "surface": [
            "è©•ä¾¡ãƒ»æœŸå¾…ãƒ»æã‚Œã®è±¡å¾´ã€‚è²¬ä»»æ„ŸãŒå¼·ã„äººã»ã©è¦‹ã‚„ã™ã„å¤¢ã€‚",
            "â€œå¤±æ•—å›é¿â€ã®æ€è€ƒãŒå¼·ã„æ™‚ã®ã‚µã‚¤ãƒ³ã«ãªã‚Šã‚„ã™ã„ã€‚",
        ],
        "deep": [
            "ä»–äººã®å£°ã¨ã„ã†ã‚ˆã‚Šã€â€œè‡ªåˆ†ã®å†…ãªã‚‹æ¡ç‚¹è€…â€ãŒå³ã—ããªã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "éå»ã®çµŒé¨“ï¼ˆå±è²¬/å¦å®šï¼‰ã®è¨˜æ†¶ãŒä»Šã®æŒ‘æˆ¦ã«é‡ãªã£ã¦ã„ã‚‹ã‹ã‚‚ã€‚",
        ],
        "action": [
            "60ç‚¹ã§æå‡ºã§ãã‚‹å½¢ã«è½ã¨ã—è¾¼ã‚€ï¼ˆå®Œç’§ä¸»ç¾©ã®è§£é™¤ï¼‰ã€‚",
            "ã€ä»Šæ—¥ã§ããŸã“ã¨ã€ã‚’2ã¤æ›¸ã„ã¦è‡ªå·±è©•ä¾¡ã‚’è£œæ­£ã™ã‚‹ã€‚",
        ],
    },
    "ãƒ—ãƒ¬ã‚¼ãƒ³/ç™ºè¡¨ã™ã‚‹": {
        "surface": [
            "è¡¨ç¾ãƒ»æŒ‘æˆ¦ãƒ»æ³¨ç›®ã®è±¡å¾´ã€‚æˆé•·æœŸã«å‡ºã‚„ã™ã„å¤¢ã€‚",
            "ä¼ãˆã‚‹åŠ›ã‚„ã€å®ŸåŠ›ã‚’è¦‹ã›ãŸã„æ¬²æ±‚ãŒé«˜ã¾ã£ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚",
        ],
        "deep": [
            "è©•ä¾¡ã•ã‚ŒãŸã„ã¨ã„ã†ã‚ˆã‚Šâ€œç†è§£ã•ã‚ŒãŸã„â€æ°—æŒã¡ãŒå¼·ã„å¯èƒ½æ€§ã€‚",
            "æº–å‚™ä¸è¶³ã§ã¯ãªãã€ç·Šå¼µã¨ã®ä»˜ãåˆã„æ–¹ãŒãƒ†ãƒ¼ãƒã‹ã‚‚ã€‚",
        ],
        "action": [
            "è¦ç‚¹ã‚’3è¡Œã§ã¾ã¨ã‚ã‚‹ï¼ˆä¼ãˆã‚‹åŠ›ãŒä¸ŠãŒã‚‹ï¼‰ã€‚",
            "ç·´ç¿’ã‚’â€œ1å›ã ã‘â€ã‚„ã‚‹ï¼ˆã‚¼ãƒ­â†’1ãŒå‹ã¡ï¼‰ã€‚",
        ],
    },
    "è·å ´ãŒå¤‰ãªå ´æ‰€/è¿·è·¯ã«ãªã£ã¦ã„ã‚‹": {
        "surface": [
            "ç’°å¢ƒå¤‰åŒ–ãƒ»æ–¹å‘æ€§ãƒ»è¿·ã„ã®è±¡å¾´ã€‚ä»Šã®åƒãæ–¹ã«é•å’Œæ„ŸãŒã‚ã‚‹æ™‚ã«å‡ºã‚„ã™ã„ã€‚",
            "ã‚„ã‚‹ã“ã¨ãŒå¤šãã€å…¨ä½“åƒãŒè¦‹ãˆãªã„ã‚µã‚¤ãƒ³ã®ã“ã¨ã‚‚ã€‚",
        ],
        "deep": [
            "æœ¬å½“ã¯â€œè‡ªåˆ†ã«åˆã†å ´æ‰€â€ã‚’æ¢ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "å½¹å‰²ã‚„ç›®æ¨™ãŒæ›–æ˜§ã§ã€å¿ƒãŒå±…å ´æ‰€ã‚’æ±‚ã‚ã¦ã„ã‚‹ã‹ã‚‚ã€‚",
        ],
        "action": [
            "ä»Šã®ä»•äº‹ã§ã€å¾—ãŸã„ã‚¹ã‚­ãƒ«ã€ã‚’1ã¤æ±ºã‚ã‚‹ã€‚",
            "â€œã‚„ã‚‰ãªã„ã“ã¨â€ã‚’æ±ºã‚ã¦ã€è¿·è·¯ã®é€šè·¯ã‚’æ¸›ã‚‰ã™ã€‚",
        ],
    },
    "ãƒ‘ã‚½ã‚³ãƒ³/ã‚¹ãƒãƒ›ãŒå£Šã‚Œã‚‹": {
        "surface": [
            "åŠ¹ç‡ãƒ»ä¸å®‰å®šãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã®è±¡å¾´ã€‚è² è·ãŒé«˜ã„æ™‚ã«å‡ºã‚„ã™ã„ã€‚",
            "é“å…·ãŒå£Šã‚Œã‚‹å¤¢ã¯â€œä¼‘ã‚â€ã®ã‚µã‚¤ãƒ³ã¨ã—ã¦ç¾ã‚Œã‚‹ã“ã¨ã‚‚ã€‚",
        ],
        "deep": [
            "åƒãæ–¹ãŒâ€œå‡ºåŠ›éå¤šâ€ã§ã€å›å¾©ãŒè¿½ã„ã¤ã„ã¦ã„ãªã„å¯èƒ½æ€§ã€‚",
            "ã€æ­¢ã¾ã£ãŸã‚‰çµ‚ã‚ã‚Šã€ã¨ã„ã†æ€ã„è¾¼ã¿ãŒã‚ã‚‹ã‹ã‚‚ã€‚",
        ],
        "action": [
            "ä¼‘æ†©ã‚’äºˆå®šã«å…¥ã‚Œã‚‹ï¼ˆ5åˆ†ã§OKã€å›å¾©ãŒåŠ¹ç‡ã«ãªã‚‹ï¼‰ã€‚",
            "ä½œæ¥­ã‚’â€œ1ã¤ãšã¤â€ã«æˆ»ã™ï¼ˆãƒãƒ«ãƒã‚¿ã‚¹ã‚¯è§£é™¤ï¼‰ã€‚",
        ],
    },
    "çµ¦æ–™/è©•ä¾¡ãŒä¸ŠãŒã‚‹ï¼ˆæ˜‡é€²ãƒ»è¡¨å½°ï¼‰": {
        "surface": [
            "æˆæœãƒ»æ‰¿èªãƒ»ä¼¸ã³ã—ã‚ã®è±¡å¾´ã€‚è‡ªä¿¡ãŒå›å¾©ã—ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚",
            "ã€ã‚‚ã£ã¨ã§ãã‚‹ã€ã¨ã„ã†å‰å‘ããªã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒè‚²ã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "deep": [
            "è©•ä¾¡ã‚’æ±‚ã‚ã‚‹ã‚ˆã‚Šã€ä¾¡å€¤æä¾›ã¸ã®æ„è­˜ãŒé«˜ã¾ã£ã¦ã„ã‚‹æ™‚ã«è¦‹ã‚„ã™ã„ã€‚",
            "â€œå—ã‘å–ã‚‹å™¨â€ãŒæ•´ã„ã¤ã¤ã‚ã‚‹ã‚µã‚¤ãƒ³ã€‚",
        ],
        "action": [
            "ä»Šæ—¥ã®æˆæœã‚’1è¡Œã§è¨˜éŒ²ã™ã‚‹ï¼ˆå¯è¦–åŒ–ï¼è©•ä¾¡ã®åœŸå°ï¼‰ã€‚",
            "å°ã•ãªææ¡ˆã‚’1ã¤å‡ºã™ï¼ˆæ”¹å–„ãƒ»è¿½åŠ ä¾¡å€¤ï¼‰ã€‚",
        ],
    },
    "ãƒŸã‚¹/ã‚„ã‚Šç›´ã—ãŒç™ºç”Ÿã™ã‚‹": {
        "surface": [
            "æ³¨æ„å–šèµ·ãƒ»ç¢ºèªä¸è¶³ãƒ»ç„¦ã‚Šã®è±¡å¾´ã€‚ã‚¹ãƒ”ãƒ¼ãƒ‰å„ªå…ˆã®æ™‚ã«å‡ºã‚„ã™ã„ã€‚",
            "ã‚„ã‚Šç›´ã—ï¼æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚‹ã€ã¨ã„ã†ã‚µã‚¤ãƒ³ã§ã‚‚ã‚ã‚‹ã€‚",
        ],
        "deep": [
            "è‡ªåˆ†ã‚’è²¬ã‚ã‚‹ã‚ˆã‚Šã€ä»•çµ„ã¿ã§å®ˆã£ãŸæ–¹ãŒä¼¸ã³ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚",
            "â€œå®Œç’§â€ã§ã¯ãªãâ€œå†ç¾æ€§â€ãŒãƒ†ãƒ¼ãƒã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "action": [
            "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’1ã¤ä½œã‚‹ï¼ˆãƒŸã‚¹ã®å†ç™ºã‚’æ½°ã™ï¼‰ã€‚",
            "5åˆ†ã ã‘æŒ¯ã‚Šè¿”ã£ã¦â€œæ¬¡ã®æ”¹å–„â€ã‚’1ã¤æ±ºã‚ã‚‹ã€‚",
        ],
    },
}

EMOTIONS = ["ä¸å®‰", "ç„¦ã‚Š", "æ€–ã„", "æ‚”ã—ã„", "å®‰å¿ƒ", "ãƒ¯ã‚¯ãƒ¯ã‚¯", "ã‚„ã‚‹æ°—", "ç„¡æ„Ÿæƒ…"]
STATES = ["ç–²ã‚Œã¦ã‚‹", "æŒ‘æˆ¦ä¸­", "åœæ»ãã¿", "å¿™ã—ã„", "çœ ã„", "ãƒ¡ãƒ³ã‚¿ãƒ«ãŒæºã‚Œã‚‹", "é›†ä¸­ã—ãŸã„", "å¤‰ã‚ã‚ŠãŸã„"]


def work_diagnose(sign_key: str, emotion: str, state: str, memo: str) -> str:
    base = WORK_SIGNS[sign_key]
    surface = random.choice(base["surface"])
    deep = random.choice(base["deep"])
    action = random.choice(base["action"])

    aura = random.choice([
        "ä»•äº‹é‹ã¯â€œé‹â€ã‚ˆã‚Šã‚‚â€œå†ç¾æ€§â€ã§ä¼¸ã³ã‚‹ã€‚",
        "ç„¦ã‚Šã¯æ‰èƒ½ã®è£è¿”ã—ã€‚æ–¹å‘ã ã‘æ•´ãˆã‚Œã°å¼·ããªã‚‹ã€‚",
        "è©•ä¾¡ã¯å¾Œã‹ã‚‰ã¤ã„ã¦ãã‚‹ã€‚ã¾ãšã¯å‡ºåŠ›ã‚’ç©ã‚€ã€‚",
        "ä»Šæ—¥ã®1æ­©ãŒã€æ¥é€±ã®ä½™è£•ã‚’ä½œã‚‹ã€‚",
    ])

    hint = ""
    if memo.strip():
        hint = f"ä»Šå›ã®å¤¢ãƒ¡ãƒ¢ï¼šã€{memo.strip()}ã€\n"

    one_line = random.choice([
        "å°ã•ãé€²ã‚ã°ã€æµã‚Œã¯å¤‰ã‚ã‚‹ã€‚",
        "ã‚„ã‚‹é‡ã‚’æ¸›ã‚‰ã—ã¦ã€å‹ã¡ã‚’å¢—ã‚„ã™ã€‚",
        "ä»Šæ—¥ã®å‡ºåŠ›ãŒã€æœªæ¥ã®ä¿¡ç”¨ã«ãªã‚‹ã€‚",
        "ç„¦ã‚‰ãªãã¦ã„ã„ã€‚æ•´ãˆã‚Œã°ä¼¸ã³ã‚‹ã€‚",
    ])

    return (
        f"{hint}"
        f"### ğŸ§© è¡¨ã®æ„å‘³ï¼ˆä»•äº‹é‹ã‚·ãƒ³ãƒœãƒ«ï¼‰\n"
        f"- {surface}\n\n"
        f"### ğŸŒ‘ è£ã®æ„å‘³ï¼ˆæ·±å±¤ãƒ»åƒãæ–¹ï¼‰\n"
        f"- {deep}\n\n"
        f"### ğŸ”” æ„Ÿæƒ…Ã—çŠ¶æ…‹ã®ãƒ’ãƒ³ãƒˆ\n"
        f"- æ„Ÿæƒ…ï¼š**{emotion}** ï¼ çŠ¶æ…‹ï¼š**{state}**\n"
        f"- {aura}\n\n"
        f"### âœ… ä»Šæ—¥ã®ä»•äº‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå°ã•ãï¼‰\n"
        f"- {action}\n\n"
        f"---\n"
        f"**ã²ã¨ã“ã¨**ï¼š{one_line}"
    )


# -------------------------
# UI
# -------------------------
st.set_page_config(page_title=APP_TITLE, layout="centered")
st.title("ğŸ§  ä»•äº‹é‹å¤¢è¨ºæ–­ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼")
st.caption("å¤¢ã‚’â€œä»•äº‹é‹Ã—å¿ƒç†â€ã§èª­ã¿è§£ãã€‚æŠ•ç¨¿ã«ã‚‚ã©ã†ãã€‚")
st.info(DISCLAIMER)

history = load_history()

st.divider()

col1, col2 = st.columns(2)
with col1:
    sign_key = st.selectbox("å¤¢ã®ã‚·ãƒ¼ãƒ³ï¼ˆé¸æŠï¼‰", list(WORK_SIGNS.keys()))
with col2:
    emotion = st.selectbox("æ„Ÿæƒ…ï¼ˆä»»æ„ï¼‰", ["ï¼ˆæœªé¸æŠï¼‰"] + EMOTIONS)

state = st.selectbox("æœ€è¿‘ã®çŠ¶æ…‹ï¼ˆä»»æ„ï¼‰", ["ï¼ˆæœªé¸æŠï¼‰"] + STATES)
memo = st.text_area("å¤¢ã®ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰", height=100, placeholder="ä¾‹ï¼šä¼šè­°ã«é…åˆ»ã—ãŸï¼è³‡æ–™ãŒè¦‹ã¤ã‹ã‚‰ãªã„â€¦ãªã©")

st.divider()

if st.button("è¨ºæ–­ã™ã‚‹", use_container_width=True):
    e = emotion if emotion != "ï¼ˆæœªé¸æŠï¼‰" else random.choice(EMOTIONS)
    s = state if state != "ï¼ˆæœªé¸æŠï¼‰" else random.choice(STATES)
    result = work_diagnose(sign_key, e, s, memo)
    st.session_state["result"] = result

if "result" in st.session_state:
    st.subheader("ğŸª„ è¨ºæ–­çµæœ")
    st.markdown(st.session_state["result"])
    st.text_area("ã‚³ãƒ”ãƒšç”¨ï¼ˆMarkdownï¼‰", st.session_state["result"], height=220)

    cA, cB = st.columns(2)
    with cA:
        if st.button("ğŸ’¾ å±¥æ­´ã«ä¿å­˜", use_container_width=True):
            history.append({
                "saved_at": dt.datetime.now().isoformat(timespec="seconds"),
                "sign": sign_key,
                "emotion": emotion,
                "state": state,
                "memo": memo.strip(),
                "result": st.session_state["result"],
            })
            save_history(history)
            st.success("ä¿å­˜ã—ãŸã‚ˆã€‚")
    with cB:
        if st.button("ğŸ§¹ ã‚¯ãƒªã‚¢", use_container_width=True):
            st.session_state.pop("result", None)
            st.rerun()

st.divider()

with st.expander("ğŸ—‚ éå»ã®è¨ºæ–­ï¼ˆæœ€æ–°10ä»¶ï¼‰"):
    if not history:
        st.write("ã¾ã ä¿å­˜ãŒãªã„ã‚ˆã€‚")
    else:
        for row in reversed(history[-10:]):
            st.markdown(f"**{row['saved_at']}ï½œ{row['sign']}ï½œ{row.get('emotion','')}ï½œ{row.get('state','')}**")
            if row.get("memo"):
                st.caption(f"ãƒ¡ãƒ¢ï¼š{row['memo']}")
            st.markdown(row["result"])
            st.write("---")
