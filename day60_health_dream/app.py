from __future__ import annotations

import json
import random
import datetime as dt
from pathlib import Path

import streamlit as st

APP_TITLE = "ğŸ§˜â€â™‚ï¸ å¥åº·é‹å¤¢è¨ºæ–­ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆDay60ï¼‰"

BASE_DIR = Path(__file__).parent
DATA_DIR = BASE_DIR / "data"
DATA_DIR.mkdir(exist_ok=True)
HISTORY_PATH = DATA_DIR / "history.json"

DISCLAIMER = "â€»ã“ã‚Œã¯å‰µä½œçš„ãƒ»å¿ƒç†çš„ãªè§£é‡ˆï¼ˆãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³å«ã‚€ï¼‰ã§ã™ã€‚åŒ»ç™‚çš„ãªè¨ºæ–­ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä½“èª¿ä¸è‰¯ãŒç¶šãå ´åˆã¯åŒ»ç™‚æ©Ÿé–¢ã¸ã€‚"


# -------------------------
# ä¿å­˜/èª­è¾¼
# -------------------------
def load_history():
    if not HISTORY_PATH.exists():
        return []
    try:
        return json.loads(HISTORY_PATH.read_text(encoding="utf-8"))
    except Exception:
        return []


def save_history(rows):
    HISTORY_PATH.write_text(json.dumps(rows, ensure_ascii=False, indent=2), encoding="utf-8")


# -------------------------
# å¥åº·é‹å¤¢ã‚·ãƒ³ãƒœãƒ«ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åˆæˆï¼‰
# -------------------------
HEALTH_SIGNS = {
    "èµ°ã‚Œãªã„/è¶³ãŒé‡ã„": {
        "surface": [
            "ç–²åŠ´ãƒ»å›å¾©ä¸è¶³ãƒ»ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã®è±¡å¾´ã€‚ä½“ãŒâ€œä¼‘ã¿ãŸã„â€ã¨è¨€ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚",
            "ç„¦ã‚ŠãŒå¼·ã„æ™‚ã«å‡ºã‚„ã™ã„å¤¢ã€‚å‰ã«é€²ã¿ãŸã„ã®ã«é€²ã‚ãªã„æ„Ÿè¦šã®è¡¨ç¾ã€‚",
        ],
        "deep": [
            "ã‚„ã‚‹æ°—ã¯ã‚ã‚‹ã®ã«ã€ä½“åŠ›ãŒè¿½ã„ã¤ã„ã¦ã„ãªã„å¯èƒ½æ€§ã€‚",
            "ã€ä¼‘ã‚€ï¼æ‚ªã„ã€ã®æ€ã„è¾¼ã¿ãŒå›å¾©ã‚’é‚ªé­”ã—ã¦ã„ã‚‹ã‹ã‚‚ã€‚",
        ],
        "action": [
            "ç¡çœ ã‚’æœ€å„ªå…ˆã«ã™ã‚‹ï¼ˆä»Šå¤œã¯+30åˆ†ï¼‰ã€‚",
            "ã‚¹ãƒˆãƒ¬ãƒƒãƒ1åˆ†ï¼‹æ°´ã‚’ä¸€æ¯ï¼ˆå›å¾©ã‚¹ã‚¤ãƒƒãƒï¼‰ã€‚",
        ],
    },
    "æ¯ãŒã§ããªã„/è‹¦ã—ã„": {
        "surface": [
            "ã‚¹ãƒˆãƒ¬ã‚¹ãƒ»ç·Šå¼µãƒ»éå‘¼å¸çš„ãªåœ§è¿«æ„Ÿã®è±¡å¾´ã€‚å¿ƒãŒè©°ã¾ã£ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã®ã“ã¨ãŒã‚ã‚‹ã€‚",
            "è²¬ä»»ã‚„ä¸å®‰ãŒé‡ã„æ™‚ã«å‡ºã‚„ã™ã„å¤¢ã€‚",
        ],
        "deep": [
            "â€œæŠ±ãˆã™ãâ€ã®å¯èƒ½æ€§ã€‚è¨€èªåŒ–ã§ããªã„ä¸å®‰ãŒæºœã¾ã£ã¦ã„ã‚‹ã‹ã‚‚ã€‚",
            "å®‰å…¨åœ°å¸¯ï¼ˆå®‰å¿ƒã§ãã‚‹æ™‚é–“/å ´æ‰€ï¼‰ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚",
        ],
        "action": [
            "å‘¼å¸ã‚’æ•´ãˆã‚‹ï¼š4ç§’å¸ã£ã¦6ç§’åãÃ—5å›ã€‚",
            "â€œä»Šã‚„ã‚‰ãªã„ã“ã¨â€ã‚’1ã¤æ±ºã‚ã¦è·ç‰©ã‚’é™ã‚ã™ã€‚",
        ],
    },
    "æ­¯ãŒæŠœã‘ã‚‹/ãƒœãƒ­ãƒœãƒ­": {
        "surface": [
            "ä½“åŠ›ä½ä¸‹ãƒ»ã‚¹ãƒˆãƒ¬ã‚¹ãƒ»è‡ªå·±è©•ä¾¡ã®æºã‚Œã®è±¡å¾´ã¨ã—ã¦å‡ºã‚„ã™ã„å®šç•ªå¤¢ã€‚",
            "ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ä¸å®‰ãŒã‚ã‚‹æ™‚ã«ç¾ã‚Œã‚„ã™ã„ã€‚",
        ],
        "deep": [
            "ã€ã¡ã‚ƒã‚“ã¨ã—ãŸã„ã€ãŒå¼·ãã€å¿ƒãŒè‡ªåˆ†ã«å³ã—ããªã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "äººå‰ã§ã®å°è±¡ã‚„ç™ºä¿¡ã«ç–²ã‚Œã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã‹ã‚‚ã€‚",
        ],
        "action": [
            "æ „é¤Šã‚’è¶³ã™ï¼šã‚¿ãƒ³ãƒ‘ã‚¯è³ªoræ¸©ã‹ã„æ±ç‰©ã‚’1å›ã€‚",
            "å®Œç’§ã‚’ã‚„ã‚ã‚‹ï¼š60ç‚¹ã§OKã®æ—¥ã‚’ä½œã‚‹ã€‚",
        ],
    },
    "ç—…é™¢/è–¬/è¨ºå¯Ÿã‚’å—ã‘ã‚‹": {
        "surface": [
            "ã‚±ã‚¢ãƒ»å›å¾©ãƒ»æ•´ãˆã‚‹æ„è­˜ã®è±¡å¾´ã€‚è‡ªåˆ†ã‚’å®ˆã‚ã†ã¨ã—ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚",
            "â€œç‚¹æ¤œâ€ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«å‡ºã‚„ã™ã„å¤¢ã€‚",
        ],
        "deep": [
            "ä½“ã‚ˆã‚Šå…ˆã«ã€å¿ƒãŒã€æ•´ãˆãŸã„ã€ã¨è¨€ã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "ä¼‘æ¯ã‚„æ”¯æ´ã‚’å—ã‘å–ã‚‹ã“ã¨ã¸ã®è¨±å¯ãŒå‡ºå§‹ã‚ã¦ã„ã‚‹ã‹ã‚‚ã€‚",
        ],
        "action": [
            "èº«ä½“ã®ç‚¹æ¤œï¼šè‚©ãƒ»é¦–ãƒ»ç›®ã‚’1åˆ†ã‚±ã‚¢ã€‚",
            "ä¸å®‰ãŒç¶šããªã‚‰â€œç›¸è«‡ã™ã‚‹â€ã‚’æ¤œè¨ï¼ˆåŒ»ç™‚/å®¶æ—/å‹äººï¼‰ã€‚",
        ],
    },
    "é£Ÿã¹ç‰©ãŒç¾å‘³ã—ã„/æº€è…¹": {
        "surface": [
            "å›å¾©ãƒ»æº€ãŸã•ã‚Œã‚‹ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼è£œçµ¦ã®è±¡å¾´ã€‚å¥åº·é‹ãŒä¸Šå‘ãã‚µã‚¤ãƒ³ã«ãªã‚Šã‚„ã™ã„ã€‚",
            "ç”Ÿæ´»ãƒªã‚ºãƒ ãŒæ•´ã„å§‹ã‚ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "deep": [
            "â€œå®‰å¿ƒâ€ãŒå¢—ãˆã¦ãã¦ã„ã‚‹ã€‚å¿ƒã¨ä½“ã®é€£å‹•ãŒè‰¯ã„æ–¹å‘ã«å‘ã„ã¦ã„ã‚‹ã‹ã‚‚ã€‚",
            "ç„¡ç†ã‚’ã‚„ã‚ã¦ã€ç´ ç›´ã«æº€ãŸã•ã‚ŒãŸã„æ°—æŒã¡ãŒã‚ã‚‹ã€‚",
        ],
        "action": [
            "é£Ÿäº‹ã‚’ä¸å¯§ã«ï¼šä¸€å£ã ã‘ã‚†ã£ãã‚Šå™›ã‚€ã€‚",
            "ä»Šæ—¥ã®å›å¾©è¡Œå‹•ã‚’1ã¤â€œæ„å›³ã—ã¦â€ã‚„ã‚‹ï¼ˆé¢¨å‘‚/æ•£æ­©/æ˜¼å¯ï¼‰ã€‚",
        ],
    },
    "æ±—ã‚’ã‹ã/é‹å‹•ã—ã¦ã„ã‚‹": {
        "surface": [
            "ä»£è¬ãƒ»æµ„åŒ–ãƒ»ã‚¹ãƒˆãƒ¬ã‚¹è§£æ”¾ã®è±¡å¾´ã€‚ä½“ãŒå‹•ããŸãŒã£ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚",
            "ã‚„ã‚‹æ°—ã¨å›å¾©ãŒçµã³ã¤ãæ™‚ã«å‡ºã‚„ã™ã„å¤¢ã€‚",
        ],
        "deep": [
            "æºœã‚è¾¼ã‚“ã ã‚‚ã®ã‚’å¤–ã¸å‡ºã—ãŸã„ã€‚æ„Ÿæƒ…ã®ãƒ‡ãƒˆãƒƒã‚¯ã‚¹ã®å¯èƒ½æ€§ã€‚",
            "â€œå¤‰ã‚ã‚ŠãŸã„â€æ°—æŒã¡ãŒä½“ãƒ¬ãƒ™ãƒ«ã«é™ã‚Šã¦ãã¦ã„ã‚‹ã€‚",
        ],
        "action": [
            "è»½ã„é‹å‹•ï¼šæ•£æ­©5åˆ†orã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ10å›ã€‚",
            "æ±—ï¼æµ„åŒ–ï¼šæ°´åˆ†ã‚’ã—ã£ã‹ã‚Šå–ã‚‹ã€‚",
        ],
    },
    "æ°´/ãŠé¢¨å‘‚/ã‚·ãƒ£ãƒ¯ãƒ¼": {
        "surface": [
            "æµ„åŒ–ãƒ»å›å¾©ãƒ»ãƒªã‚»ãƒƒãƒˆã®è±¡å¾´ã€‚ç–²ã‚Œã‚’æµã—ãŸã„æ™‚ã«å‡ºã‚„ã™ã„ã€‚",
            "æ„Ÿæƒ…ãŒæºœã¾ã£ã¦ã„ã‚‹æ™‚ã«ã‚‚ç¾ã‚Œã‚„ã™ã„å¤¢ã€‚",
        ],
        "deep": [
            "éå»ã®ãƒ¢ãƒ¤ãƒ¢ãƒ¤ã‚’æ‰‹æ”¾ã—ãŸã„ã‚µã‚¤ãƒ³ã€‚",
            "â€œå¿ƒã®æ¸…æ½”æ„Ÿâ€ã‚’å–ã‚Šæˆ»ã—ãŸã„æ¬²æ±‚ãŒã‚ã‚‹ã‹ã‚‚ã€‚",
        ],
        "action": [
            "å…¥æµ´oræ¸©ã‹ã„é£²ã¿ç‰©ã§ä½“æ¸©ã‚’ä¸Šã’ã‚‹ã€‚",
            "ã‚¹ãƒãƒ›ã‹ã‚‰é›¢ã‚Œã‚‹æ™‚é–“ã‚’5åˆ†ä½œã‚‹ï¼ˆè„³ã®å›å¾©ï¼‰ã€‚",
        ],
    },
    "å‚·/å‡ºè¡€/ç—›ã¿": {
        "surface": [
            "ç„¡ç†ã®ã‚µã‚¤ãƒ³ãƒ»æ³¨æ„å–šèµ·ã®è±¡å¾´ã€‚ä½“ãŒã€é™ç•Œè¿‘ã„ã€ã¨è¨€ã£ã¦ã„ã‚‹ã“ã¨ã‚‚ã€‚",
            "å¯¾äººã‚¹ãƒˆãƒ¬ã‚¹ã‚„è‡ªå·±å¦å®šãŒåæ˜ ã•ã‚Œã‚‹å ´åˆã‚‚ã‚ã‚‹ã€‚",
        ],
        "deep": [
            "é ‘å¼µã‚Šã‚’è‡ªåˆ†ã§è¦‹è½ã¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚ã‚±ã‚¢ä¸è¶³ã®è­¦å‘Šã‹ã‚‚ã€‚",
            "ç—›ã¿ï¼å¢ƒç•Œç·šã€‚å«Œãªã“ã¨ã‚’æˆ‘æ…¢ã—ã™ãã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "action": [
            "ä»Šæ—¥ã®è² è·ã‚’ä¸‹ã’ã‚‹ï¼šäºˆå®šã‚’1ã¤è»½ãã™ã‚‹ã€‚",
            "â€œå«Œã ã£ãŸã“ã¨â€ã‚’1è¡Œã§æ›¸ã„ã¦æ‰‹æ”¾ã™ã€‚",
        ],
    },
}

EMOTIONS = ["å®‰å¿ƒ", "ä¸å®‰", "æ€–ã„", "ç„¦ã‚Š", "ç–²ã‚Œ", "ã‚¹ãƒƒã‚­ãƒª", "ãƒ¯ã‚¯ãƒ¯ã‚¯", "ç„¡æ„Ÿæƒ…"]
STATES = ["ç–²ã‚Œã¦ã‚‹", "æŒ‘æˆ¦ä¸­", "åœæ»ãã¿", "å¿™ã—ã„", "çœ ã„", "ãƒ¡ãƒ³ã‚¿ãƒ«ãŒæºã‚Œã‚‹", "é›†ä¸­ã—ãŸã„", "æ•´ãˆãŸã„"]


def health_diagnose(sign_key: str, emotion: str, state: str, memo: str) -> str:
    base = HEALTH_SIGNS[sign_key]
    surface = random.choice(base["surface"])
    deep = random.choice(base["deep"])
    action = random.choice(base["action"])

    aura = random.choice([
        "å¥åº·é‹ã¯â€œæ°—åˆâ€ã‚ˆã‚Šâ€œå›å¾©â€ã§ä¸ŠãŒã‚‹ã€‚",
        "ä½“ã¯ã„ã¤ã‚‚æ­£ç›´ã€‚å¤¢ã¯ãã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¿»è¨³ã—ã¦ã‚‹ã ã‘ã€‚",
        "å°‘ã—æ•´ãˆã‚‹ã ã‘ã§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯æˆ»ã‚‹ã€‚",
        "ä¼‘ã‚€ã®ã¯å‰é€²ã€‚å›å¾©ã¯æœ€å¼·ã®æŠ•è³‡ã€‚",
    ])

    hint = ""
    if memo.strip():
        hint = f"ä»Šå›ã®å¤¢ãƒ¡ãƒ¢ï¼šã€{memo.strip()}ã€\n"

    one_line = random.choice([
        "ä»Šæ—¥ã¯å›å¾©ãŒæœ€å„ªå…ˆã§OKã€‚",
        "å°ã•ãæ•´ãˆã‚‹ã»ã©ã€å¼·ããªã‚Œã‚‹ã€‚",
        "ä½“ãŒå‘³æ–¹ã«ãªã‚‹ã¨ã€å…¨éƒ¨ãŒé€²ã‚€ã€‚",
        "ç„¦ã‚‰ãªã„ã€‚ã¾ãšã¯ä¼‘ã‚€ã€‚",
    ])

    return (
        f"{hint}"
        f"### ğŸŒ¿ è¡¨ã®æ„å‘³ï¼ˆå¥åº·é‹ã‚·ãƒ³ãƒœãƒ«ï¼‰\n"
        f"- {surface}\n\n"
        f"### ğŸŒ‘ è£ã®æ„å‘³ï¼ˆæ·±å±¤ãƒ»å›å¾©ã®èª²é¡Œï¼‰\n"
        f"- {deep}\n\n"
        f"### ğŸ”” æ„Ÿæƒ…Ã—çŠ¶æ…‹ã®ãƒ’ãƒ³ãƒˆ\n"
        f"- æ„Ÿæƒ…ï¼š**{emotion}** ï¼ çŠ¶æ…‹ï¼š**{state}**\n"
        f"- {aura}\n\n"
        f"### âœ… ä»Šæ—¥ã®å¥åº·ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå°ã•ãï¼‰\n"
        f"- {action}\n\n"
        f"---\n"
        f"**ã²ã¨ã“ã¨**ï¼š{one_line}"
    )


# -------------------------
# UI
# -------------------------
st.set_page_config(page_title=APP_TITLE, layout="centered")
st.title("ğŸ§˜â€â™‚ï¸ å¥åº·é‹å¤¢è¨ºæ–­ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼")
st.caption("å¤¢ã‚’â€œå¥åº·é‹Ã—å¿ƒç†â€ã§èª­ã¿è§£ãã€‚ä½“èª¿ä¸å®‰ãŒã‚ã‚Œã°ç„¡ç†ã—ãªã„ã§ã­ã€‚")
st.info(DISCLAIMER)

history = load_history()

st.divider()

col1, col2 = st.columns(2)
with col1:
    sign_key = st.selectbox("å¤¢ã®ã‚·ãƒ¼ãƒ³ï¼ˆé¸æŠï¼‰", list(HEALTH_SIGNS.keys()))
with col2:
    emotion = st.selectbox("æ„Ÿæƒ…ï¼ˆä»»æ„ï¼‰", ["ï¼ˆæœªé¸æŠï¼‰"] + EMOTIONS)

state = st.selectbox("æœ€è¿‘ã®çŠ¶æ…‹ï¼ˆä»»æ„ï¼‰", ["ï¼ˆæœªé¸æŠï¼‰"] + STATES)
memo = st.text_area("å¤¢ã®ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰", height=100, placeholder="ä¾‹ï¼šæ¯ãŒè‹¦ã—ã‹ã£ãŸï¼æ°´ã«å…¥ã£ã¦ãŸâ€¦ãªã©")

st.divider()

if st.button("è¨ºæ–­ã™ã‚‹", use_container_width=True):
    e = emotion if emotion != "ï¼ˆæœªé¸æŠï¼‰" else random.choice(EMOTIONS)
    s = state if state != "ï¼ˆæœªé¸æŠï¼‰" else random.choice(STATES)
    result = health_diagnose(sign_key, e, s, memo)
    st.session_state["result"] = result

if "result" in st.session_state:
    st.subheader("ğŸª„ è¨ºæ–­çµæœ")
    st.markdown(st.session_state["result"])
    st.text_area("ã‚³ãƒ”ãƒšç”¨ï¼ˆMarkdownï¼‰", st.session_state["result"], height=220)

    cA, cB = st.columns(2)
    with cA:
        if st.button("ğŸ’¾ å±¥æ­´ã«ä¿å­˜", use_container_width=True):
            history.append({
                "saved_at": dt.datetime.now().isoformat(timespec="seconds"),
                "sign": sign_key,
                "emotion": emotion,
                "state": state,
                "memo": memo.strip(),
                "result": st.session_state["result"],
            })
            save_history(history)
            st.success("ä¿å­˜ã—ãŸã‚ˆã€‚")
    with cB:
        if st.button("ğŸ§¹ ã‚¯ãƒªã‚¢", use_container_width=True):
            st.session_state.pop("result", None)
            st.rerun()

st.divider()

with st.expander("ğŸ—‚ éå»ã®è¨ºæ–­ï¼ˆæœ€æ–°10ä»¶ï¼‰"):
    if not history:
        st.write("ã¾ã ä¿å­˜ãŒãªã„ã‚ˆã€‚")
    else:
        for row in reversed(history[-10:]):
            st.markdown(f"**{row['saved_at']}ï½œ{row['sign']}ï½œ{row.get('emotion','')}ï½œ{row.get('state','')}**")
            if row.get("memo"):
                st.caption(f"ãƒ¡ãƒ¢ï¼š{row['memo']}")
            st.markdown(row["result"])
            st.write("---")
