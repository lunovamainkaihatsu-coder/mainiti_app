from __future__ import annotations

import json
import random
import datetime as dt
from pathlib import Path

import streamlit as st

APP_TITLE = "ğŸ¤ å¯¾äººé‹å¤¢è¨ºæ–­ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆDay61ï¼‰"

BASE_DIR = Path(__file__).parent
DATA_DIR = BASE_DIR / "data"
DATA_DIR.mkdir(exist_ok=True)
HISTORY_PATH = DATA_DIR / "history.json"

DISCLAIMER = "â€»ã“ã‚Œã¯å‰µä½œçš„ãƒ»å¿ƒç†çš„ãªè§£é‡ˆï¼ˆãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³å«ã‚€ï¼‰ã§ã™ã€‚ç›¸æ‰‹ã®æ„å›³ã®æ–­å®šãƒ»é–¢ä¿‚ã®çµæœä¿è¨¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"


# -------------------------
# ä¿å­˜/èª­è¾¼
# -------------------------
def load_history():
    if not HISTORY_PATH.exists():
        return []
    try:
        return json.loads(HISTORY_PATH.read_text(encoding="utf-8"))
    except Exception:
        return []


def save_history(rows):
    HISTORY_PATH.write_text(json.dumps(rows, ensure_ascii=False, indent=2), encoding="utf-8")


# -------------------------
# å¯¾äººé‹å¤¢ã‚·ãƒ³ãƒœãƒ«ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åˆæˆï¼‰
# -------------------------
SOCIAL_SIGNS = {
    "çŸ¥ã‚‰ãªã„äººã¨è©±ã™": {
        "surface": [
            "æ–°ã—ã„å‡ºä¼šã„ãƒ»è¦–ç‚¹ãƒ»å¯èƒ½æ€§ã®è±¡å¾´ã€‚äººé–“é–¢ä¿‚ãŒåºƒãŒã‚‹å‰å…†ã¨ã—ã¦å‡ºã‚„ã™ã„ã€‚",
            "è‡ªåˆ†ã®ä¸­ã®â€œæœªçŸ¥ã®å´é¢â€ã¨ä¼šè©±ã—ã¦ã„ã‚‹å ´åˆã‚‚ã‚ã‚‹ã€‚",
        ],
        "deep": [
            "æœ¬å½“ã¯ã‚‚ã£ã¨äººã¨ã¤ãªãŒã‚ŠãŸã„æ°—æŒã¡ãŒã‚ã‚‹å¯èƒ½æ€§ã€‚",
            "è­¦æˆ’ã‚ˆã‚Šå¥½å¥‡å¿ƒãŒä¸ŠãŒã£ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚å¤‰åŒ–ã‚’å—ã‘å…¥ã‚Œã‚‹æº–å‚™ã‹ã‚‚ã€‚",
        ],
        "action": [
            "ä¸€è¨€ã ã‘æŒ¨æ‹¶ï¼‹ç¬‘é¡”ï¼ˆå°ã•ãªæ¥ç‚¹ã‚’ä½œã‚‹ï¼‰ã€‚",
            "æ–°ã—ã„ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å€™è£œã‚’1ã¤æ¢ã™ï¼ˆè¦‹ã‚‹ã ã‘ã§OKï¼‰ã€‚",
        ],
    },
    "å¤§å‹¢ã®å‰ã«ç«‹ã¤/æ³¨ç›®ã•ã‚Œã‚‹": {
        "surface": [
            "è©•ä¾¡ãƒ»å­˜åœ¨æ„Ÿãƒ»ç™ºä¿¡ã®è±¡å¾´ã€‚è‡ªåˆ†ã‚’è¦‹ã›ãŸã„æ°—æŒã¡ãŒé«˜ã¾ã£ã¦ã„ã‚‹ã€‚",
            "ç·Šå¼µã¨æœŸå¾…ãŒæ··ã–ã‚‹æ™‚ã«å‡ºã‚„ã™ã„å¤¢ã€‚",
        ],
        "deep": [
            "ã€å«Œã‚ã‚ŒãŸããªã„ã€ã‚ˆã‚Šã€èªã‚ã‚‰ã‚ŒãŸã„ã€ãŒå¼·ã„å¯èƒ½æ€§ã€‚",
            "è‡ªå·±è¡¨ç¾ã®æ¬²æ±‚ãŒè‚²ã£ã¦ã„ã‚‹ã€‚ä»Šã¯â€œå‡ºã™ç·´ç¿’æœŸâ€ã‹ã‚‚ã€‚",
        ],
        "action": [
            "çŸ­ã„ç™ºä¿¡ã‚’1ã¤å‡ºã™ï¼ˆæŠ•ç¨¿/ãƒ¡ãƒ¢å…±æœ‰ï¼‰ã€‚",
            "è‡ªå·±ç´¹ä»‹æ–‡ã‚’1è¡Œæ›´æ–°ã™ã‚‹ï¼ˆè‡ªåˆ†ã®è¼ªéƒ­ã‚’æ•´ãˆã‚‹ï¼‰ã€‚",
        ],
    },
    "è¿·å­ã«ãªã‚‹/äººæ··ã¿ã§å›°ã‚‹": {
        "surface": [
            "æƒ…å ±éå¤šãƒ»æ°—ç–²ã‚Œãƒ»å±…å ´æ‰€æ¢ã—ã®è±¡å¾´ã€‚å¯¾äººã‚¹ãƒˆãƒ¬ã‚¹ãŒã‚ã‚‹æ™‚ã«å‡ºã‚„ã™ã„ã€‚",
            "å‘¨å›²ã«åˆã‚ã›ã™ãã¦ã€è‡ªåˆ†ã®è»¸ãŒè–„ããªã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "deep": [
            "æœ¬å½“ã¯â€œå®‰å¿ƒã§ãã‚‹å°‘äººæ•°â€ãŒå¿…è¦ãªæ™‚æœŸã‹ã‚‚ã€‚",
            "å¢ƒç•Œç·šï¼ˆè·é›¢æ„Ÿï¼‰ã‚’æ•´ãˆãŸã„ã‚µã‚¤ãƒ³ã€‚",
        ],
        "action": [
            "äººã¨ä¼šã†äºˆå®šã®å¾Œã«â€œå›å¾©æ™‚é–“â€ã‚’å…¥ã‚Œã‚‹ã€‚",
            "SNS/é€£çµ¡ã‚’çŸ­æ™‚é–“ã ã‘ã‚ªãƒ•ï¼ˆè„³ã®é™ã‘ã•ã‚’ä½œã‚‹ï¼‰ã€‚",
        ],
    },
    "å–§å˜©ã™ã‚‹/è¨€ã„äº‰ã„": {
        "surface": [
            "æœ¬éŸ³ãƒ»å¢ƒç•Œç·šãƒ»æˆ‘æ…¢ã®é™ç•Œã®è±¡å¾´ã€‚æºœã‚è¾¼ã¿ãŒã‚ã‚‹æ™‚ã«å‡ºã‚„ã™ã„ã€‚",
            "é–¢ä¿‚ã®æ‚ªåŒ–ã¨ã„ã†ã‚ˆã‚Šã€èª¿æ•´ãŒå¿…è¦ã¨ã„ã†ã‚µã‚¤ãƒ³ã®å ´åˆã‚‚ã€‚",
        ],
        "deep": [
            "ã€åˆ†ã‹ã£ã¦ã»ã—ã„ã€ãŒæºœã¾ã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "å„ªã—ã•ãŒè£ç›®ã«å‡ºã¦ã€è‡ªåˆ†ã‚’å¾Œå›ã—ã«ã—ã¦ã„ã‚‹ã‹ã‚‚ã€‚",
        ],
        "action": [
            "è¨€ã„ãŸã„ã“ã¨ã‚’â€œçŸ­ããƒ»è²¬ã‚ãšã«â€1è¡Œã§æ›¸ãã€‚",
            "NOã¨è¨€ã†ç·´ç¿’ï¼šå°ã•ãªæ–­ã‚Šã‚’1å›ã—ã¦ã¿ã‚‹ã€‚",
        ],
    },
    "ç„¡è¦–ã•ã‚Œã‚‹/è©±ãŒé€šã˜ãªã„": {
        "surface": [
            "ä¸å®‰ãƒ»å­¤ç‹¬æ„Ÿãƒ»æ‰¿èªæ¬²æ±‚ã®æºã‚Œã®è±¡å¾´ã€‚ç¹Šç´°ãªæ™‚ã«å‡ºã‚„ã™ã„å¤¢ã€‚",
            "ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®â€œã™ã‚Œé•ã„â€ã‚’è­¦æˆ’ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "deep": [
            "ç›¸æ‰‹ã®åå¿œã‚’â€œè‡ªå·±ä¾¡å€¤â€ã¨çµã³ã¤ã‘ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
            "æœ¬å½“ã¯ã€å®‰å¿ƒã—ãŸã„ã€ã ã‘ã§ã€ç­”ãˆåˆã‚ã›ã‚’æ±‚ã‚ã¦ã„ã‚‹ã‚ã‘ã˜ã‚ƒãªã„å ´åˆã‚‚ã€‚",
        ],
        "action": [
            "äº‹å®Ÿã¨æƒ³åƒã‚’åˆ†ã‘ã¦æ›¸ãï¼ˆä¾‹ï¼šè¿”äº‹ãŒé…ã„ï¼å«Œã„ã€ã§ã¯ãªã„ï¼‰ã€‚",
            "å®‰å¿ƒã§ãã‚‹ç›¸æ‰‹ã«çŸ­ãè¿‘æ³ã‚’é€ã‚‹ï¼ˆå°ã•ãªã¤ãªãŒã‚Šï¼‰ã€‚",
        ],
    },
    "å‹é”ã¨ç¬‘ã£ã¦ã„ã‚‹/ä»²è‰¯ãéã”ã™": {
        "surface": [
            "å¯¾äººé‹ã®ä¸Šå‘ãã€ä¿¡é ¼ã€å±…å¿ƒåœ°ã®è‰¯ã„é–¢ä¿‚ã®è±¡å¾´ã€‚",
            "äººé–“é–¢ä¿‚ãŒâ€œæ•´ç†ã•ã‚Œã¦è‰¯ã„ç¸ãŒæ®‹ã‚‹â€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ã“ã¨ã‚‚ã€‚",
        ],
        "deep": [
            "è‡ªåˆ†ãŒè‡ªç„¶ä½“ã«ãªã‚Œã‚‹å ´æ‰€ã‚’æ±‚ã‚ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã€‚",
            "ç„¡ç†ã‚’ã—ãªã„é–¢ä¿‚ãŒãƒ†ãƒ¼ãƒã€‚é‡ã‚ˆã‚Šè³ªã¸ç§»è¡Œä¸­ã‹ã‚‚ã€‚",
        ],
        "action": [
            "ä¼šã„ãŸã„äººã‚’1äººæ€ã„å‡ºã—ã¦ã€æ—¥ç¨‹ã¯æ±ºã‚ãšã«ãƒ¡ãƒƒã‚»ã ã‘é€ã‚‹ã€‚",
            "è‡ªåˆ†ã®â€œå¥½ãâ€ã‚’1ã¤å…±æœ‰ã™ã‚‹ï¼ˆå…±é€šç‚¹ãŒç¸ã‚’ä½œã‚‹ï¼‰ã€‚",
        ],
    },
    "èª°ã‹ã«åŠ©ã‘ã‚‰ã‚Œã‚‹/åŠ©ã‘ã‚‹": {
        "surface": [
            "æ”¯æ´ãƒ»ä¿¡é ¼ãƒ»å¾ªç’°ã®è±¡å¾´ã€‚äººã®ç¸ãŒåƒãã‚„ã™ã„æ™‚ã«å‡ºã‚‹ã€‚",
            "åŠ©ã‘ã‚‹å¤¢ã¯â€œå½¹å‰²â€ãŒå¢—ãˆã‚‹ã‚µã‚¤ãƒ³ã®å ´åˆã‚‚ã‚ã‚‹ã€‚",
        ],
        "deep": [
            "å—ã‘å–ã‚‹å™¨ãŒæ•´ã„ã¤ã¤ã‚ã‚‹ã€‚é ¼ã£ã¦ã‚‚ã„ã„ã‚µã‚¤ãƒ³ã€‚",
            "é€†ã«ã€äººã«å°½ãã—ã™ãã¦ã„ã‚‹å ´åˆã¯â€œå¢ƒç•Œç·šâ€ã®è¦‹ç›´ã—ãŒãƒ†ãƒ¼ãƒã€‚",
        ],
        "action": [
            "é ¼ã‚ã‚‹ã“ã¨ã‚’1ã¤ã ã‘é ¼ã‚€ï¼ˆå°ã•ãã§OKï¼‰ã€‚",
            "æ‰‹ä¼ã£ãŸã‚‰ã€åŒã˜ã ã‘è‡ªåˆ†ã‚‚ä¼‘ã¾ã›ã‚‹ï¼ˆå¾ªç’°ã®ãƒãƒ©ãƒ³ã‚¹ï¼‰ã€‚",
        ],
    },
    "èª°ã‹ã«è¿½ã‚ã‚Œã‚‹/é¿ã‘ã‚‹": {
        "surface": [
            "ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ãƒ»å¯¾äººä¸å®‰ãƒ»è·é›¢ã‚’å–ã‚ŠãŸã„æ¬²æ±‚ã®è±¡å¾´ã€‚",
            "è‹¦æ‰‹ãªç›¸æ‰‹ã‚„çŠ¶æ³ã‚’â€œè¿½è·¡è€…â€ã¨ã—ã¦å¤¢ãŒè¡¨ç¾ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚",
        ],
        "deep": [
            "æœ¬å½“ã¯ã€å®‰å…¨ã«è·é›¢ã‚’å–ã‚ŠãŸã„ã€ã ã‘ã‹ã‚‚ã—ã‚Œãªã„ã€‚",
            "å¯¾äººã‚ˆã‚Šå…ˆã«ã€ç–²åŠ´ãŒåŸå› ã§æ•æ„Ÿã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ã€‚",
        ],
        "action": [
            "ä¼šã†é »åº¦/é€£çµ¡é »åº¦ã®â€œç†æƒ³â€ã‚’1è¡Œã§æ±ºã‚ã‚‹ã€‚",
            "ä½“åŠ›å›å¾©ã‚’å„ªå…ˆï¼ˆç¡çœ ãƒ»é£Ÿäº‹ãƒ»æ•£æ­©ï¼‰ï¼å¯¾äººé‹ã®åœŸå°ã€‚",
        ],
    },
}

EMOTIONS = ["å¬‰ã—ã„", "ä¸å®‰", "ç„¦ã‚Š", "æ€–ã„", "å¯‚ã—ã„", "å®‰å¿ƒ", "ãƒ¯ã‚¯ãƒ¯ã‚¯", "æ€’ã‚Š", "ç„¡æ„Ÿæƒ…"]
STATES = ["ç–²ã‚Œã¦ã‚‹", "æŒ‘æˆ¦ä¸­", "åœæ»ãã¿", "å¿™ã—ã„", "çœ ã„", "ãƒ¡ãƒ³ã‚¿ãƒ«ãŒæºã‚Œã‚‹", "äººç–²ã‚Œ", "æ•´ãˆãŸã„"]


def social_diagnose(sign_key: str, emotion: str, state: str, memo: str) -> str:
    base = SOCIAL_SIGNS[sign_key]
    surface = random.choice(base["surface"])
    deep = random.choice(base["deep"])
    action = random.choice(base["action"])

    aura = random.choice([
        "å¯¾äººé‹ã¯â€œç›¸æ‰‹ã‚’å¤‰ãˆã‚‹â€ã‚ˆã‚Šâ€œè·é›¢æ„Ÿã‚’æ•´ãˆã‚‹â€ã§ä¸ŠãŒã‚‹ã€‚",
        "è‰¯ã„ç¸ã¯ã€è‡ªç„¶ä½“ã®ã‚ãªãŸã«é›†ã¾ã‚‹ã€‚",
        "è¨€è‘‰ã‚ˆã‚Šå…ˆã«ã€å›å¾©ãŒã‚³ãƒŸãƒ¥åŠ›ã‚’æˆ»ã™ã€‚",
        "å°ã•ãªã¤ãªãŒã‚ŠãŒã€æœªæ¥ã®å®‰å¿ƒã«ãªã‚‹ã€‚",
    ])

    hint = ""
    if memo.strip():
        hint = f"ä»Šå›ã®å¤¢ãƒ¡ãƒ¢ï¼šã€{memo.strip()}ã€\n"

    one_line = random.choice([
        "ç„¡ç†ã«æ„›æƒ³ã‚’æŒ¯ã‚Šã¾ã‹ãªãã¦ã„ã„ã€‚",
        "åˆã†äººã ã‘æ®‹ã‚Œã°ã„ã„ã€‚ç¸ã¯æ•´ã†ã€‚",
        "ä»Šæ—¥ã®ä¸€è¨€ãŒã€é–¢ä¿‚ã‚’å¤‰ãˆã‚‹ã€‚",
        "è·é›¢ã‚’æ•´ãˆã‚‹ã¨ã€å„ªã—ã•ãŒæˆ»ã‚‹ã€‚",
    ])

    return (
        f"{hint}"
        f"### ğŸ«¶ è¡¨ã®æ„å‘³ï¼ˆå¯¾äººé‹ã‚·ãƒ³ãƒœãƒ«ï¼‰\n"
        f"- {surface}\n\n"
        f"### ğŸŒ‘ è£ã®æ„å‘³ï¼ˆæ·±å±¤ãƒ»é–¢ä¿‚ã®ãƒ†ãƒ¼ãƒï¼‰\n"
        f"- {deep}\n\n"
        f"### ğŸ”” æ„Ÿæƒ…Ã—çŠ¶æ…‹ã®ãƒ’ãƒ³ãƒˆ\n"
        f"- æ„Ÿæƒ…ï¼š**{emotion}** ï¼ çŠ¶æ…‹ï¼š**{state}**\n"
        f"- {aura}\n\n"
        f"### âœ… ä»Šæ—¥ã®å¯¾äººã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå°ã•ãï¼‰\n"
        f"- {action}\n\n"
        f"---\n"
        f"**ã²ã¨ã“ã¨**ï¼š{one_line}"
    )


# -------------------------
# UI
# -------------------------
st.set_page_config(page_title=APP_TITLE, layout="centered")
st.title("ğŸ¤ å¯¾äººé‹å¤¢è¨ºæ–­ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼")
st.caption("å¤¢ã‚’â€œå¯¾äººé‹Ã—å¿ƒç†â€ã§èª­ã¿è§£ãã€‚ç›¸æ‰‹ã®æ„å›³ã¯æ–­å®šã—ãªã„ã‚ˆã€‚")
st.info(DISCLAIMER)

history = load_history()

st.divider()

col1, col2 = st.columns(2)
with col1:
    sign_key = st.selectbox("å¤¢ã®ã‚·ãƒ¼ãƒ³ï¼ˆé¸æŠï¼‰", list(SOCIAL_SIGNS.keys()))
with col2:
    emotion = st.selectbox("æ„Ÿæƒ…ï¼ˆä»»æ„ï¼‰", ["ï¼ˆæœªé¸æŠï¼‰"] + EMOTIONS)

state = st.selectbox("æœ€è¿‘ã®çŠ¶æ…‹ï¼ˆä»»æ„ï¼‰", ["ï¼ˆæœªé¸æŠï¼‰"] + STATES)
memo = st.text_area("å¤¢ã®ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰", height=100, placeholder="ä¾‹ï¼šäººæ··ã¿ã§è¿·ã£ãŸï¼ç„¡è¦–ã•ã‚ŒãŸâ€¦ãªã©")

st.divider()

if st.button("è¨ºæ–­ã™ã‚‹", use_container_width=True):
    e = emotion if emotion != "ï¼ˆæœªé¸æŠï¼‰" else random.choice(EMOTIONS)
    s = state if state != "ï¼ˆæœªé¸æŠï¼‰" else random.choice(STATES)
    result = social_diagnose(sign_key, e, s, memo)
    st.session_state["result"] = result

if "result" in st.session_state:
    st.subheader("ğŸª„ è¨ºæ–­çµæœ")
    st.markdown(st.session_state["result"])
    st.text_area("ã‚³ãƒ”ãƒšç”¨ï¼ˆMarkdownï¼‰", st.session_state["result"], height=220)

    cA, cB = st.columns(2)
    with cA:
        if st.button("ğŸ’¾ å±¥æ­´ã«ä¿å­˜", use_container_width=True):
            history.append({
                "saved_at": dt.datetime.now().isoformat(timespec="seconds"),
                "sign": sign_key,
                "emotion": emotion,
                "state": state,
                "memo": memo.strip(),
                "result": st.session_state["result"],
            })
            save_history(history)
            st.success("ä¿å­˜ã—ãŸã‚ˆã€‚")
    with cB:
        if st.button("ğŸ§¹ ã‚¯ãƒªã‚¢", use_container_width=True):
            st.session_state.pop("result", None)
            st.rerun()

st.divider()

with st.expander("ğŸ—‚ éå»ã®è¨ºæ–­ï¼ˆæœ€æ–°10ä»¶ï¼‰"):
    if not history:
        st.write("ã¾ã ä¿å­˜ãŒãªã„ã‚ˆã€‚")
    else:
        for row in reversed(history[-10:]):
            st.markdown(f"**{row['saved_at']}ï½œ{row['sign']}ï½œ{row.get('emotion','')}ï½œ{row.get('state','')}**")
            if row.get("memo"):
                st.caption(f"ãƒ¡ãƒ¢ï¼š{row['memo']}")
            st.markdown(row["result"])
            st.write("---")
