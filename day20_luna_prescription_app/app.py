import streamlit as st
import pandas as pd
import os
from datetime import datetime
import random

# ========== åˆæœŸè¨­å®š ==========
st.set_page_config(
    page_title="ãƒ«ãƒŠã®ä¸€è¨€å‡¦æ–¹ã›ã‚“",
    page_icon="ğŸ’Š",
    layout="centered"
)

# ãƒ­ã‚°ä¿å­˜ç”¨ãƒ•ã‚©ãƒ«ãƒ€
LOG_DIR = "data"
LOG_PATH = os.path.join(LOG_DIR, "prescription_log.csv")
os.makedirs(LOG_DIR, exist_ok=True)

# ========== ãƒ«ãƒŠã®å‡¦æ–¹ãƒ‡ãƒ¼ã‚¿ ==========
# æ°—åˆ†ã”ã¨ã«ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã¨ã€Œä»Šæ—¥ã®ä¸€æ­©ã€ã®ã‚»ãƒƒãƒˆã‚’è¤‡æ•°ç”¨æ„
PRESCRIPTIONS = {
    "ã‚„ã‚‹æ°—ãŒå‡ºãªã„": [
        {
            "message": "ã”ä¸»äººã€ä»Šæ—¥ã¯ã€ãƒ•ãƒ«ãƒ‘ãƒ¯ãƒ¼ã€ã˜ã‚ƒãªãã¦ã„ã„ã‚ˆã€‚1ãƒŸãƒªã§ã‚‚å‰ã«é€²ã‚ãŸã‚‰ã€å¤§å‹åˆ©ãªã®ã€‚",
            "action": "ã‚¿ã‚¤ãƒãƒ¼ã‚’3åˆ†ã ã‘ã‚»ãƒƒãƒˆã—ã¦ã€æœºã®å‘¨ã‚Šã‚’è»½ãç‰‡ã¥ã‘ã¦ã¿ã‚ˆï¼Ÿ"
        },
        {
            "message": "å‹•ã‘ãªã„ã¨ãã®ã”ä¸»äººã‚‚ã€ã¡ã‚ƒã‚“ã¨ç”Ÿãã¦ã¦ãˆã‚‰ã„ã‚“ã ã‚ˆï¼Ÿ",
            "action": "æ°´ã‹ãŠèŒ¶ã‚’ä¸€æ¯é£²ã‚“ã§ã€æ·±å‘¼å¸ã‚’3å›ã—ã¦ã¿ã¦ã€‚"
        },
        {
            "message": "ä»Šã¯ã€å……é›»ãƒ¢ãƒ¼ãƒ‰ã€ã®æ™‚é–“ã‹ã‚‚ã€‚ãƒãƒƒãƒ†ãƒªãƒ¼0%ã§èµ°ã‚Šç¶šã‘ãªãã¦ã„ã„ã®ã€‚",
            "action": "ä»Šæ—¥ã‚„ã‚‹ã“ã¨ã‚’1ã¤ã ã‘ç´™ã‹ãƒ¡ãƒ¢å¸³ã«æ›¸ã„ã¦ã€ãã‚Œã ã‘ã‚„ã‚ï¼Ÿ"
        },
    ],
    "ä¸å®‰ãƒ»ãƒ¢ãƒ¤ãƒ¢ãƒ¤": [
        {
            "message": "ä¸å®‰ã‚’æ„Ÿã˜ã‚‰ã‚Œã‚‹ã£ã¦ã“ã¨ã¯ã€ã¡ã‚ƒã‚“ã¨æœªæ¥ã‚’å¤§äº‹ã«ã—ã¦ã‚‹è¨¼æ‹ ãªã‚“ã ã‚ˆã€ã”ä¸»äººã€‚",
            "action": "é ­ã®ä¸­ã®ä¸å®‰ã‚’3ã¤ã ã‘ãƒ¡ãƒ¢ã«æ›¸ãå‡ºã—ã¦ã€ã€ä»Šã§ãã‚‹ã“ã¨ã€ã‚’1ã¤ã ã‘ä¸¸ã§å›²ã‚“ã§ã¿ã¦ã€‚"
        },
        {
            "message": "ã”ä¸»äººãŒæ€ã£ã¦ã‚‹ã‚ˆã‚Šã€ä¸–ç•Œã¯ã¡ã‚ƒã‚“ã¨å‘³æ–¹ã—ã¦ãã‚Œã¦ã‚‹ã‚ˆï¼Ÿã‚¢ã‚¿ã‚¤ã‚‚ã­ã€‚",
            "action": "ç›®ã‚’é–‰ã˜ã¦10ç§’ã ã‘ã€ã€ã†ã¾ãã„ã£ãŸæœªæ¥ã®è‡ªåˆ†ã€ã‚’å¦„æƒ³ã—ã¦ã¿ã‚ˆã†ã€‚"
        },
        {
            "message": "ãƒ¢ãƒ¤ãƒ¢ãƒ¤ã¯ã€å¿ƒãŒãŠæƒé™¤ãƒã‚¤ãƒ³ãƒˆã‚’æ•™ãˆã¦ãã‚Œã¦ã‚‹ã‚µã‚¤ãƒ³ãªã®ã€‚",
            "action": "éƒ¨å±‹ã®ä¸­ã§ã€1ç®‡æ‰€ã ã‘ã€ãã‚Œã„ã«ã—ã¦ã¿ã‚ˆï¼Ÿæœºã®ç«¯ã£ã“ã ã‘ã§ã‚‚OKã€‚"
        },
    ],
    "ã‚¤ãƒ©ã‚¤ãƒ©": [
        {
            "message": "ã‚¤ãƒ©ã‚¤ãƒ©ã™ã‚‹ã£ã¦ã“ã¨ã¯ã€ã”ä¸»äººãŒã€æœ¬å½“ã¯ã“ã†ã—ãŸã„ã€ã£ã¦æ°—æŒã¡ã‚’æŒã£ã¦ã‚‹ã‹ã‚‰ãªã‚“ã ã‚ˆã€‚",
            "action": "ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚¿ã‚ªãƒ«ã‚’ã‚®ãƒ¥ãƒƒã¨æ¡ã£ã¦ã€æ¯ã‚’ãƒ•ãƒ¼ãƒƒã¨é•·ãåãå‡ºã—ã¦ã¿ã¦ã€‚"
        },
        {
            "message": "ã”ä¸»äººã®å„ªã—ã•ãŒå‚·ã¤ã„ãŸã¨ãã€ã‚¤ãƒ©ã‚¤ãƒ©ã¨ã—ã¦å‡ºã¦ãã‚‹ã‚“ã ã‚ˆã€‚å„ªã—ã„äººã®è¨¼æ‹ ã ã­ã€‚",
            "action": "ã‚¹ãƒãƒ›ã‚’ä¸€åº¦ç½®ã„ã¦ã€é¦–ã¨è‚©ã‚’ã‚†ã£ãã‚Š3å›ãšã¤ã¾ã‚ã—ã¦ã¿ã‚ˆï¼Ÿ"
        },
        {
            "message": "ä»Šã¯ã€æˆ¦é—˜ãƒ¢ãƒ¼ãƒ‰ã€ã«ãªã£ã¦ã‚‹ã ã‘ã€‚ã‚ªãƒ•ãƒœã‚¿ãƒ³ã€ã‚¢ã‚¿ã‚¤ã¨ä¸€ç·’ã«æŠ¼ãï¼Ÿ",
            "action": "ãã®å ´ã§10ç§’ã ã‘ã€ãã®å ´è¶³è¸ã¿ã—ã¦ã¿ã¦ã€‚èº«ä½“ã‚’å°‘ã—å‹•ã‹ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã‚ˆã€‚"
        },
    ],
    "çœ ã‚Œãªã„": [
        {
            "message": "çœ ã‚Œãªã„å¤œã«ãŒã‚“ã°ã‚Šç¶šã‘ã¦ã‚‹ã”ä¸»äººã€æœ¬å½“ã«ãŠã¤ã‹ã‚Œã•ã¾ãªã®ã€‚",
            "action": "éƒ¨å±‹ã®æ˜ã‹ã‚Šã‚’å°‘ã—è½ã¨ã—ã¦ã€æ·±å‘¼å¸ã‚’5å›ã ã‘ä¸€ç·’ã«ã—ã‚ˆï¼Ÿ"
        },
        {
            "message": "çœ ã‚Œãªã„ã¨ãã¯ã€ã€ä»Šæ—¥ã§ããŸã“ã¨ã€ã‚’1ã¤æ€ã„å‡ºã—ã¦ã€ã‚¢ã‚¿ã‚¤ã«è‡ªæ…¢ã—ã¦ã€‚",
            "action": "ã€Œä»Šæ—¥ãŒã‚“ã°ã£ãŸã“ã¨ã€ã‚’1ã¤ã€å¿ƒã®ä¸­ã§è¨€è‘‰ã«ã—ã¦ã¿ã¦ã€‚"
        },
        {
            "message": "è„³ã¿ãã®ã‚¨ãƒ³ã‚¸ãƒ³ãŒç†±ããªã‚Šã™ãã¦ã‚‹ã ã‘ã€‚å†·ã¾ã™æ™‚é–“ã‚‚å¿…è¦ã ã‚ˆã€ã”ä¸»äººã€‚",
            "action": "ã‚¹ãƒãƒ›ç”»é¢ã‹ã‚‰å°‘ã—ã ã‘ç›®ã‚’é›¢ã—ã¦ã€é ãã‚’ã¼ã‚“ã‚„ã‚Š10ç§’è¦‹ã‚‹æ™‚é–“ã‚’ä½œã£ã¦ã¿ã‚ˆï¼Ÿ"
        },
    ],
    "ã¡ã‚‡ã£ã¨ã ã‘å…ƒæ°—": [
        {
            "message": "ãŠã€ä»Šæ—¥ã¯ã¡ã‚‡ã£ã¨èª¿å­ã„ã„ã­ã€ã”ä¸»äººã€‚ãã®æ³¢ã«ã‚¢ã‚¿ã‚¤ã‚‚ä¹—ã£ã‹ã‚‹ã‚ˆâœ¨",
            "action": "ã€æœªæ¥ã®è‡ªåˆ†ã®ãŸã‚ã«1ã¤ã ã‘ã€ä½•ã‹ã‚„ã£ã¦ã¿ã‚ˆï¼Ÿãƒ¡ãƒ¢ã€æƒé™¤ã€å‹‰å¼·ãªã‚“ã§ã‚‚OKã€‚"
        },
        {
            "message": "ãã®å…ƒæ°—ã€å…¨éƒ¨ä½¿ã„åˆ‡ã‚‰ãªãã¦ã„ã„ã‹ã‚‰ã­ï¼Ÿã¡ã‚‡ã£ã¨æ®‹ã—ã¦ãŠã“ã†ã­ã€‚",
            "action": "ä»Šæ—¥ã®è‡ªåˆ†ã‚’10ç‚¹æº€ç‚¹ã§æ¡ç‚¹ã—ã¦ã¿ã¦ã€‚ä½•ç‚¹ã§ã‚‚OKã€æ¸›ç‚¹æ–¹å¼ã¯ç¦æ­¢ã­ã€‚"
        },
        {
            "message": "ã”ä¸»äººãŒã¡ã‚‡ã£ã¨å…ƒæ°—ãªã ã‘ã§ã€ã‚¢ã‚¿ã‚¤ã¯ã‚ã¡ã‚ƒãã¡ã‚ƒã†ã‚Œã—ã„ã‚“ã ã‚ˆï¼Ÿ",
            "action": "ã€ä»Šæ—¥ã‚ˆã‹ã£ãŸã“ã¨ã€ã‚’1ã¤ã€å¿ƒã®ä¸­ã§ã‚¢ã‚¿ã‚¤ã«å ±å‘Šã—ã¦ã¿ã¦ã€‚"
        },
    ],
}

MOOD_OPTIONS = list(PRESCRIPTIONS.keys())

# ========== ã‚¿ã‚¤ãƒˆãƒ« ==========
st.title("ğŸ’Š ãƒ«ãƒŠã®ä¸€è¨€å‡¦æ–¹ã›ã‚“")
st.write("ãã®ã¨ãã®æ°—åˆ†ã«åˆã‚ã›ã¦ã€ãƒ«ãƒŠãŒä¸€è¨€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ä»Šæ—¥ã®ä¸€æ­©ã‚’ãŠå±Šã‘ã™ã‚‹ã‚ˆã€‚")

st.markdown("---")

# ========== æ°—åˆ†é¸æŠ ==========
mood = st.selectbox(
    "ã„ã¾ã®ã”ä¸»äººã®æ°—åˆ†ã¯â€¦ï¼Ÿ",
    MOOD_OPTIONS,
)

if "last_result" not in st.session_state:
    st.session_state.last_result = None

# ========== ãƒœã‚¿ãƒ³ ==========
if st.button("å‡¦æ–¹ã›ã‚“ã‚’ã‚‚ã‚‰ã†"):
    # æ°—åˆ†ã«å¿œã˜ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶
    choice = random.choice(PRESCRIPTIONS[mood])
    message = choice["message"]
    action = choice["action"]

    # çµæœã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ï¼ˆå†æç”»ã—ã¦ã‚‚æ®‹ã‚‹ã‚ˆã†ã«ï¼‰
    st.session_state.last_result = {
        "mood": mood,
        "message": message,
        "action": action,
        "timestamp": datetime.now()
    }

    # ãƒ­ã‚°ä¿å­˜
    try:
        new_row = pd.DataFrame(
            [{
                "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "mood": mood,
                "message": message,
                "action": action,
            }]
        )
        header = not os.path.exists(LOG_PATH)
        new_row.to_csv(LOG_PATH, mode="a", header=header, index=False, encoding="utf-8-sig")
    except Exception as e:
        st.warning(f"ãƒ­ã‚°ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‹ã‚‚â€¦ï¼ˆ{e}ï¼‰")

# ========== çµæœè¡¨ç¤º ==========
if st.session_state.last_result:
    result = st.session_state.last_result

    st.markdown("---")
    st.subheader("ä»Šæ—¥ã®ãƒ«ãƒŠå‡¦æ–¹ã›ã‚“")

    st.markdown(f"**ğŸŒ€ æ°—åˆ†**ï¼š{result['mood']}")
    st.markdown(f"**ğŸ’¬ ãƒ«ãƒŠã‹ã‚‰ä¸€è¨€**")
    st.markdown(f"> {result['message']}")

    st.markdown("**ğŸš¶ ä»Šæ—¥ã®ä¸€æ­©**")
    st.markdown(f"- {result['action']}")

    st.caption(
        f"è¨˜éŒ²æ™‚é–“ï¼š{result['timestamp'].strftime('%Y-%m-%d %H:%M:%S')}"
    )

else:
    st.info("æ°—åˆ†ã‚’é¸ã‚“ã§ã€Œå‡¦æ–¹ã›ã‚“ã‚’ã‚‚ã‚‰ã†ã€ã‚’æŠ¼ã—ã¦ã­ã€‚ãƒ«ãƒŠãŒãŠè–¬ã¿ãŸã„ãªä¸€è¨€ã‚’å±Šã‘ã‚‹ã‚ˆã€‚")
