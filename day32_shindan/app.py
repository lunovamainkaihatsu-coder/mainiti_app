# app.py
import streamlit as st
from datetime import datetime
from pathlib import Path
import json

# =========================
# åŸºæœ¬è¨­å®š
# =========================
st.set_page_config(page_title="äººç”Ÿãƒ‘ã‚¿ãƒ¼ãƒ³è¨ºæ–­", page_icon="ğŸŒ™", layout="centered")

APP_TITLE = "ğŸŒ™ äººç”Ÿãƒ‘ã‚¿ãƒ¼ãƒ³è¨ºæ–­"
DATA_DIR = Path(__file__).parent / "data"
HISTORY_PATH = DATA_DIR / "history.json"

# ä¿å­˜å…ˆã®ä½œæˆ
DATA_DIR.mkdir(exist_ok=True)

def load_history() -> list:
    if HISTORY_PATH.exists():
        try:
            return json.loads(HISTORY_PATH.read_text(encoding="utf-8"))
        except Exception:
            return []
    return []

def save_history(history: list) -> None:
    HISTORY_PATH.write_text(json.dumps(history, ensure_ascii=False, indent=2), encoding="utf-8")

def now_str() -> str:
    return datetime.now().strftime("%Y-%m-%d %H:%M")

# =========================
# è¨ºæ–­çµæœãƒ†ã‚­ã‚¹ãƒˆ
# =========================
RESULTS = {
    "A": {
        "name": "â‘  éå‰°è²¬ä»»ãƒ«ãƒ¼ãƒ—å‹",
        "subtitle": "â€•ã€ŒèƒŒè² ã„ã™ãã¦ããŸé­‚ã€â€•",
        "body": """ã‚ãªãŸã¯ã“ã‚Œã¾ã§ã€
**ã€Œè‡ªåˆ†ãŒé ‘å¼µã‚‰ãªã‘ã‚Œã°å›ã‚‰ãªã„ã€**
ãã‚“ãªæ„Ÿè¦šã‚’æŠ±ãˆãªãŒã‚‰ç”Ÿãã¦ãã¾ã—ãŸã€‚

é ¼ã‚‰ã‚Œã‚‹ã“ã¨ãŒå¤šãã€æœŸå¾…ã«å¿œãˆç¶šã‘ã€
æ°—ã¥ã‘ã°è²¬ä»»ã®è¼ªã®ä¸­å¿ƒã«ç«‹ã£ã¦ã„ã‚‹ã€‚
æœ¬å½“ã¯ç–²ã‚Œã¦ã„ã¦ã‚‚ã€å¼±éŸ³ã‚’åãã“ã¨ãŒã§ããªã‹ã£ãŸã¯ãšã§ã™ã€‚

### ğŸ”’ ç„¡æ„è­˜ã®ãƒ–ãƒ­ãƒƒã‚¯
> ã€Œå½¹ã«ç«‹ãŸãªã„è‡ªåˆ†ã«ã¯ä¾¡å€¤ãŒãªã„ã€

ã§ã‚‚ãã‚Œã¯ã€
**ã‚ãªãŸãŒâ€œå„ªã—ã•ã§é¸ã°ã‚Œã¦ããŸäººç”Ÿâ€ã ã£ãŸè¨¼æ‹ **ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚

### ğŸŒ± ä»Šã€å¿…è¦ãªè¦–ç‚¹
å…¨éƒ¨ã‚’èƒŒè² ã‚ãªãã¦ã‚‚ã€ä¸–ç•Œã¯å£Šã‚Œã¾ã›ã‚“ã€‚
ã‚ãªãŸãŒå°‘ã—åŠ›ã‚’æŠœãã“ã¨ã§ã€
åˆã‚ã¦ä»–äººãŒè‡ªåˆ†ã®å½¹å‰²ã‚’æ€ã„å‡ºã™ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚

### ğŸ— ä»Šæ—¥ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ğŸ‘‰ **ä»Šæ—¥ã¯1ã¤ã ã‘ã€Œã‚„ã‚‰ãªãã¦ã„ã„ã“ã¨ã€ã‚’æ±ºã‚ã¦ãã ã•ã„ã€‚**
ãã‚Œã¯é€ƒã’ã§ã¯ãªãã€å›å¾©ã§ã™ã€‚
""",
        "one_action": "ä»Šæ—¥ã¯1ã¤ã ã‘ã€Œã‚„ã‚‰ãªãã¦ã„ã„ã“ã¨ã€ã‚’æ±ºã‚ã‚‹",
        "share": "ä»Šæ—¥ã®è‡ªåˆ†ãƒ†ãƒ¼ãƒï¼šèƒŒè² ã„ã™ãã‚’æ‰‹æ”¾ã™ã€‚ã¾ãšã¯ã€Œã‚„ã‚‰ãªãã¦ã„ã„ã“ã¨ã€ã‚’1ã¤æ±ºã‚ã‚‹ã€‚"
    },
    "B": {
        "name": "â‘¡ è‡ªå·±å¦å®šâ†’å†æŒ‘æˆ¦ãƒ«ãƒ¼ãƒ—å‹",
        "subtitle": "â€•ã€Œä½•åº¦ã‚‚ç«‹ã¡ä¸ŠãŒã£ã¦ããŸé­‚ã€â€•",
        "body": """ã‚ãªãŸã¯æŒ‘æˆ¦ã™ã‚‹åŠ›ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
ãã‚Œã§ã‚‚ã€çµæœãŒå‡ºãªã„ã¨
**ä¸€æ°—ã«è‡ªåˆ†ã‚’å¦å®šã—ã¦ã—ã¾ã†**ç™–ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

ã€Œã¾ãŸãƒ€ãƒ¡ã ã£ãŸã€
ã€Œã‚„ã£ã±ã‚Šè‡ªåˆ†ã«ã¯ç„¡ç†ã ã€
ãã†ã‚„ã£ã¦ã€æŒ‘æˆ¦ã®ãŸã³ã«è‡ªåˆ†ã‚’è²¬ã‚ã¦ãã¾ã›ã‚“ã§ã—ãŸã‹ã€‚

### ğŸ”’ ç„¡æ„è­˜ã®ãƒ–ãƒ­ãƒƒã‚¯
> ã€ŒæˆåŠŸã—ã¦ã‚‚ã€ã©ã†ã›å¤±ã†ã€

éå»ã«ã€æœŸå¾…ã—ãŸåˆ†ã ã‘å‚·ã¤ã„ãŸçµŒé¨“ãŒ
ä»Šã‚‚ã‚ãªãŸã‚’å®ˆã‚ã†ã¨ã—ã¦ã„ã‚‹ã®ã§ã™ã€‚

### ğŸŒ± ä»Šã€å¿…è¦ãªè¦–ç‚¹
ã‚ãªãŸã¯å¤±æ•—ã—ã¦ã‚‚ä¾¡å€¤ãŒä¸‹ãŒã‚‰ãªã„äººã§ã™ã€‚
ã‚€ã—ã‚ã€**æŒ‘æˆ¦ã—ç¶šã‘ã¦ããŸäº‹å®Ÿ**ã¯æ¶ˆãˆã¾ã›ã‚“ã€‚

### ğŸ— ä»Šæ—¥ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ğŸ‘‰ **ä»Šæ—¥ã‚„ã£ãŸã“ã¨ã‚’3ã¤æ›¸ãå‡ºã™ï¼ˆè©•ä¾¡ã¯ã—ãªã„ï¼‰ã€‚**
äº‹å®Ÿã ã‘ã‚’è¦‹ã‚‹ã»ã©ã€è‡ªå·±ä¿¡é ¼ã¯æˆ»ã£ã¦ãã¾ã™ã€‚
""",
        "one_action": "ä»Šæ—¥ã‚„ã£ãŸã“ã¨ã‚’3ã¤æ›¸ãå‡ºã™ï¼ˆè©•ä¾¡ã—ãªã„ï¼‰",
        "share": "ä»Šæ—¥ã®è‡ªåˆ†ãƒ†ãƒ¼ãƒï¼šè‡ªå·±å¦å®šã‚’æ­¢ã‚ã¦äº‹å®Ÿã‚’è¦‹ã‚‹ã€‚ä»Šæ—¥ã‚„ã£ãŸã“ã¨ã‚’3ã¤æ›¸ãå‡ºã™ã€‚"
    },
    "C": {
        "name": "â‘¢ ç†æƒ³å…ˆè¡Œãƒ»ç¾å®Ÿç–²å¼Šå‹",
        "subtitle": "â€•ã€Œãƒ“ã‚¸ãƒ§ãƒ³ã‚’æŠ±ãã™ããŸé­‚ã€â€•",
        "body": """ã‚ãªãŸã¯ã€
äººã‚ˆã‚Šã‚‚ãšã£ã¨é ãã‚’è¦‹ã¦ã„ã¾ã™ã€‚

ç†æƒ³ã€ä¸–ç•Œè¦³ã€æœªæ¥åƒã€‚
ã§ã‚‚ç¾å®ŸãŒè¿½ã„ã¤ã‹ãšã€
**ãã®ã‚®ãƒ£ãƒƒãƒ—ã§å¿ƒãŒæ“¦ã‚Šåˆ‡ã‚Œã¦ããŸ**ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

### ğŸ”’ ç„¡æ„è­˜ã®ãƒ–ãƒ­ãƒƒã‚¯
> ã€Œä¸€æ°—ã«å¤‰ã‚ã‚Œãªã„ãªã‚‰æ„å‘³ãŒãªã„ã€

ãã®æ€ã„è¾¼ã¿ãŒã€
ã‚ãªãŸã‚’ä½•åº¦ã‚‚ç–²ã‚Œã•ã›ã¦ãã¾ã—ãŸã€‚

### ğŸŒ± ä»Šã€å¿…è¦ãªè¦–ç‚¹
ç†æƒ³ã¯â€œç‡ƒæ–™â€ã§ã‚ã£ã¦ã€â€œç¾©å‹™â€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
10ï¼…ãšã¤ç¾å®Ÿã«é™ã‚ã—ã¦ã„ãã“ã¨ã§ã€
ç†æƒ³ã¯åˆã‚ã¦ã‚ãªãŸã‚’åŠ©ã‘å§‹ã‚ã¾ã™ã€‚

### ğŸ— ä»Šæ—¥ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ğŸ‘‰ **ç†æƒ³ã‚’10ï¼…ã ã‘ç¾å®Ÿã«è½ã¨ã™è¡Œå‹•ã‚’1ã¤ã€‚**
å®Œç’§ã§ãªãã¦ã„ã„ã€‚ç¶šãå½¢ãŒæ­£è§£ã§ã™ã€‚
""",
        "one_action": "ç†æƒ³ã‚’10ï¼…ã ã‘ç¾å®Ÿã«è½ã¨ã™è¡Œå‹•ã‚’1ã¤",
        "share": "ä»Šæ—¥ã®è‡ªåˆ†ãƒ†ãƒ¼ãƒï¼šç†æƒ³ã‚’10ï¼…ã ã‘ç¾å®Ÿã¸ã€‚å®Œç’§ã˜ã‚ƒãªãã¦ã„ã„ã€ç¶šãå½¢ã‚’é¸ã¶ã€‚"
    },
    "D": {
        "name": "â‘£ å®‰å¿ƒæ¬ ä¹ãƒ»å¸¸æ™‚ç·Šå¼µå‹",
        "subtitle": "â€•ã€Œãšã£ã¨æ°—ã‚’å¼µã£ã¦ããŸé­‚ã€â€•",
        "body": """ã‚ãªãŸã¯ã€
ä¼‘ã‚“ã§ã„ã‚‹æ™‚ã§ã•ãˆ
ã©ã“ã‹ç·Šå¼µãŒæŠœã‘ãªã„äººã§ã™ã€‚

ã€Œä½•ã‹èµ·ãã‚‹æ°—ãŒã™ã‚‹ã€
ã€Œæ²¹æ–­ã™ã‚‹ã¨å´©ã‚Œã‚‹æ°—ãŒã™ã‚‹ã€
ãã‚“ãªæ„Ÿè¦šã¨é•·ãä»˜ãåˆã£ã¦ããŸã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

### ğŸ”’ ç„¡æ„è­˜ã®ãƒ–ãƒ­ãƒƒã‚¯
> ã€Œå®‰å¿ƒã™ã‚‹ã¨ã€æ‚ªã„ã“ã¨ãŒèµ·ãã‚‹ã€

ãã‚Œã¯ã€éå»ã«â€œçªç„¶å£Šã‚ŒãŸå®‰å¿ƒâ€ã‚’
çµŒé¨“ã—ã¦ããŸè¨¼ã§ã™ã€‚

### ğŸŒ± ä»Šã€å¿…è¦ãªè¦–ç‚¹
å®‰å¿ƒã¯ã€åŠªåŠ›ã®ã”è¤’ç¾ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
**ç”Ÿãã¦ã„ã‚‹ã ã‘ã§è¨±ã•ã‚Œã¦ã„ã„çŠ¶æ…‹**ã§ã™ã€‚

### ğŸ— ä»Šæ—¥ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ğŸ‘‰ **3åˆ†é–“ã€ä½•ã‚‚ã—ãªã„æ™‚é–“ã‚’è‡ªåˆ†ã«è¨±ã™ã€‚**
å›å¾©ã¯ã€é™ã‹ã«å§‹ã¾ã‚Šã¾ã™ã€‚
""",
        "one_action": "3åˆ†é–“ã€ä½•ã‚‚ã—ãªã„æ™‚é–“ã‚’è¨±ã™",
        "share": "ä»Šæ—¥ã®è‡ªåˆ†ãƒ†ãƒ¼ãƒï¼šå®‰å¿ƒã‚’å–ã‚Šæˆ»ã™ã€‚ã¾ãšã¯3åˆ†ã€ä½•ã‚‚ã—ãªã„æ™‚é–“ã‚’è‡ªåˆ†ã«è¨±ã™ã€‚"
    },
    "E": {
        "name": "â‘¤ ä¾¡å€¤è¨¼æ˜ä¾å­˜å‹",
        "subtitle": "â€•ã€Œçµæœã§è‡ªåˆ†ã‚’å®ˆã£ã¦ããŸé­‚ã€â€•",
        "body": """ã‚ãªãŸã¯ã€
æˆæœãƒ»æ•°å­—ãƒ»è©•ä¾¡ã§
è‡ªåˆ†ã®ä¾¡å€¤ã‚’è¨¼æ˜ã—ç¶šã‘ã¦ãã¾ã—ãŸã€‚

ä½•ã‚‚ç”Ÿã¿å‡ºã›ãªã„æ—¥ã¯ã€
å­˜åœ¨ãã®ã‚‚ã®ãŒä¸å®‰ã«ãªã‚‹ã€‚
ãã‚“ãªæ„Ÿè¦šã‚’æŠ±ãˆãªãŒã‚‰é€²ã‚“ã§ããŸã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

### ğŸ”’ ç„¡æ„è­˜ã®ãƒ–ãƒ­ãƒƒã‚¯
> ã€ŒæˆæœãŒãªã„è‡ªåˆ†ã¯æ„›ã•ã‚Œãªã„ã€

ã§ã‚‚æœ¬å½“ã¯ã€
æˆæœãŒâ€œã‚ãªãŸã‚’å®ˆã‚‹é§â€ã«ãªã£ã¦ã„ãŸã ã‘ã§ã™ã€‚

### ğŸŒ± ä»Šã€å¿…è¦ãªè¦–ç‚¹
ã‚ãªãŸã®ä¾¡å€¤ã¯ã€
çµæœãŒå‡ºã‚‹å‰ã‹ã‚‰å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚
é§ã‚’è„±ã„ã§ã‚‚ã€æ¶ˆãˆã¾ã›ã‚“ã€‚

### ğŸ— ä»Šæ—¥ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ğŸ‘‰ **çµæœã¨ç„¡é–¢ä¿‚ãªè‡ªåˆ†ã®è‰¯ã•ã‚’1ã¤æ›¸ãã€‚**
ãã‚Œã¯ã€ã“ã‚Œã‹ã‚‰ã®ã‚ãªãŸã‚’æ”¯ãˆã‚‹æ ¸ã«ãªã‚Šã¾ã™ã€‚
""",
        "one_action": "çµæœã¨ç„¡é–¢ä¿‚ãªè‡ªåˆ†ã®è‰¯ã•ã‚’1ã¤æ›¸ã",
        "share": "ä»Šæ—¥ã®è‡ªåˆ†ãƒ†ãƒ¼ãƒï¼šçµæœã§è‡ªåˆ†ã‚’æ¸¬ã‚‰ãªã„ã€‚çµæœã¨ç„¡é–¢ä¿‚ãªè‡ªåˆ†ã®è‰¯ã•ã‚’1ã¤æ›¸ãã€‚"
    },
}

# =========================
# è³ªå•
# =========================
QUESTIONS = [
    {
        "q": "Q1. æœ€è¿‘ã„ã¡ã°ã‚“å¼·ãæ„Ÿã˜ã‚‹æ„Ÿè¦šã¯ï¼Ÿ",
        "opts": [
            ("A", "è‡ªåˆ†ãŒé ‘å¼µã‚‰ãªã„ã¨å…¨éƒ¨å´©ã‚Œãã†"),
            ("B", "ã‚„ã£ã¦ã‚‚ã©ã†ã›â€¦ã¨ã„ã†æ°—æŒã¡"),
            ("C", "ç†æƒ³ã¨ç¾å®Ÿã®å·®ã«ç–²ã‚Œã¦ã„ã‚‹"),
            ("D", "å¸¸ã«ã©ã“ã‹ç·Šå¼µã—ã¦ã„ã‚‹"),
            ("E", "çµæœã‚’å‡ºã•ãªã„ã¨ä¾¡å€¤ãŒãªã„æ°—ãŒã™ã‚‹"),
        ],
    },
    {
        "q": "Q2. ã†ã¾ãã„ã‹ãªã„æ™‚ã€å¿ƒã®ä¸­ã§æµ®ã‹ã³ã‚„ã™ã„è¨€è‘‰ã¯ï¼Ÿ",
        "opts": [
            ("A", "çµå±€ã€è‡ªåˆ†ã®ã›ã„ã "),
            ("B", "ã‚„ã£ã±ã‚Šè‡ªåˆ†ã«ã¯ç„¡ç†ã "),
            ("C", "ã“ã‚“ãªã¯ãšã˜ã‚ƒãªã„"),
            ("D", "ã“ã®ã¾ã¾ã§å¤§ä¸ˆå¤«ã ã‚ã†ã‹"),
            ("E", "ä½•ã‚‚æ®‹ã›ã¦ã„ãªã„"),
        ],
    },
    {
        "q": "Q3. ç‰©äº‹ã«å–ã‚Šçµ„ã‚€æ™‚ã®ã‚¯ã‚»ã¯ï¼Ÿ",
        "opts": [
            ("A", "è²¬ä»»ã‚’å¼•ãå—ã‘ã™ãã‚‹"),
            ("B", "ä¸€åº¦æŠ˜ã‚Œã‚‹ã¨ç«‹ã¦ç›´ã—ã«æ™‚é–“ãŒã‹ã‹ã‚‹"),
            ("C", "æœ€åˆã‹ã‚‰ç†æƒ³åƒãŒå¤§ãã„"),
            ("D", "å¸¸ã«æœ€æ‚ªã‚’æƒ³å®šã™ã‚‹"),
            ("E", "æˆæœãŒå‡ºã‚‹ã‹ã§ã‚„ã‚‹æ°—ãŒæ±ºã¾ã‚‹"),
        ],
    },
    {
        "q": "Q4. ä¼‘ã‚€ã“ã¨ã«ã¤ã„ã¦ã€ã„ã¡ã°ã‚“è¿‘ã„æ„Ÿè¦šã¯ï¼Ÿ",
        "opts": [
            ("A", "ä¼‘ã‚“ã§ã„ã‚‹å ´åˆã˜ã‚ƒãªã„"),
            ("B", "ä¼‘ã‚€ã¨ç½®ã„ã¦ã„ã‹ã‚Œãã†"),
            ("C", "ä¼‘ã‚€ã‚ˆã‚Šé€²ã¿ãŸã„"),
            ("D", "ä¼‘ã‚“ã§ã‚‚å¿ƒãŒä¼‘ã¾ã‚‰ãªã„"),
            ("E", "ä¼‘ã‚€ï¼ä½•ã‚‚ç”Ÿã¿å‡ºã—ã¦ã„ãªã„"),
        ],
    },
    {
        "q": "Q5. ä»–äººã‹ã‚‰ã®è©•ä¾¡ã§æ°—ã«ãªã‚Šã‚„ã™ã„ã®ã¯ï¼Ÿ",
        "opts": [
            ("A", "æœŸå¾…ã«å¿œãˆã‚‰ã‚Œã¦ã„ã‚‹ã‹"),
            ("B", "è¦‹ä¸‹ã•ã‚Œã¦ã„ãªã„ã‹"),
            ("C", "ç†è§£ã•ã‚Œã¦ã„ãªã„æ°—ãŒã™ã‚‹"),
            ("D", "å«Œã‚ã‚Œã¦ã„ãªã„ã‹"),
            ("E", "å½¹ã«ç«‹ã£ã¦ã„ã‚‹ã‹"),
        ],
    },
    {
        "q": "Q6. ã“ã‚Œã¾ã§ã®äººç”Ÿã§å¤šã‹ã£ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ï¼Ÿ",
        "opts": [
            ("A", "é ¼ã‚‰ã‚Œã¦èƒŒè² ã„ã™ãã‚‹"),
            ("B", "æŒ‘æˆ¦â†’è‡ªå·±å¦å®šâ†’å†æŒ‘æˆ¦"),
            ("C", "ç†æƒ³ã‚’æã„ã¦ç‡ƒãˆå°½ãã‚‹"),
            ("D", "å®‰å¿ƒã§ãã‚‹æ™‚æœŸãŒçŸ­ã„"),
            ("E", "çµæœãŒå‡ºãŸæ™‚ã ã‘å®‰å¿ƒã™ã‚‹"),
        ],
    },
    {
        "q": "Q7. ä»Šã€ã„ã¡ã°ã‚“æ¬²ã—ã„ã‚‚ã®ã¯ï¼Ÿ",
        "opts": [
            ("A", "è‚©ã®åŠ›ã‚’æŠœã„ã¦ã‚‚å¤§ä¸ˆå¤«ã¨ã„ã†æ„Ÿè¦š"),
            ("B", "è‡ªåˆ†ã‚’ä¿¡ã˜ã‚‰ã‚Œã‚‹æ„Ÿè¦š"),
            ("C", "ç¾å®Ÿã¨å™›ã¿åˆã†å¸Œæœ›"),
            ("D", "å®‰å¿ƒã—ã¦å‘¼å¸ã§ãã‚‹æ™‚é–“"),
            ("E", "çµæœãŒãªãã¦ã‚‚èªã‚ã‚‰ã‚Œã‚‹æ„Ÿè¦š"),
        ],
    },
]

def calc_scores(answers: list[str]) -> dict:
    scores = {"A": 0, "B": 0, "C": 0, "D": 0, "E": 0}
    for a in answers:
        if a in scores:
            scores[a] += 1
    return scores

def pick_types(scores: dict) -> tuple[str, str | None]:
    # ãƒ¡ã‚¤ãƒ³ï¼æœ€å¤šã€ã‚µãƒ–ï¼æ¬¡ç‚¹ï¼ˆåŒç‚¹ãŒã‚ã‚Œã°å®‰å®šçš„ã«ä¸¦ã¹ã‚‹ï¼‰
    sorted_items = sorted(scores.items(), key=lambda x: (-x[1], x[0]))
    main_key, main_val = sorted_items[0]
    # ã‚µãƒ–å€™è£œï¼šmainä»¥å¤–ã§æœ€å¤§
    sub_key = None
    for k, v in sorted_items[1:]:
        if v == 0:
            break
        sub_key = k
        break
    # ã‚‚ã—å…¨ã¦åŒç‚¹(ä¾‹: 1ãšã¤)ã§ã‚‚ sub ã¯2ä½ã¨ã—ã¦å‡ºã™
    if sub_key is None and len(sorted_items) > 1:
        sub_key = sorted_items[1][0]
    # ãŸã ã— main_val ãŒ 0 ã®ç•°å¸¸ã‚±ãƒ¼ã‚¹ã¯ None
    if main_val == 0:
        return ("A", None)
    return (main_key, sub_key)

def build_share_text(main_key: str, sub_key: str | None, user_note: str) -> str:
    main = RESULTS[main_key]["name"]
    sub = RESULTS[sub_key]["name"] if sub_key else None
    lines = []
    lines.append(f"ğŸŒ™äººç”Ÿãƒ‘ã‚¿ãƒ¼ãƒ³è¨ºæ–­ï¼š{main}")
    if sub:
        lines.append(f"ï¼ˆã‚µãƒ–å‚¾å‘ï¼š{sub}ï¼‰")
    lines.append(RESULTS[main_key]["share"])
    if user_note.strip():
        lines.append("")
        lines.append(f"ãƒ¡ãƒ¢ï¼š{user_note.strip()}")
    lines.append("")
    lines.append("#äººç”Ÿãƒ‘ã‚¿ãƒ¼ãƒ³è¨ºæ–­ #å†…è¦³ #ã‚»ãƒ«ãƒ•ã‚±ã‚¢")
    return "\n".join(lines)

# =========================
# UI
# =========================
st.title(APP_TITLE)
st.caption("ã‚ãŸã—ãŒã€ã‚ãªãŸã®â€œäººç”Ÿã®ç¹°ã‚Šè¿”ã—â€ã«åå‰ã‚’ã¤ã‘ã‚‹ã‚ˆã€‚â€»åŒ»ç™‚ãƒ»è¨ºæ–­è¡Œç‚ºã§ã¯ãªãã‚»ãƒ«ãƒ•å†…è¦³ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚")

tab1, tab2 = st.tabs(["ğŸ§  è¨ºæ–­ã™ã‚‹", "ğŸ“š å±¥æ­´"])

with tab1:
    st.subheader("è³ªå•ã«ç­”ãˆã¦ã­ï¼ˆ7å•ï¼‰")

    # å›ç­”ã®ä¿æŒ
    if "answers" not in st.session_state:
        st.session_state.answers = [""] * len(QUESTIONS)
    if "result" not in st.session_state:
        st.session_state.result = None

    for i, item in enumerate(QUESTIONS):
        opts = item["opts"]
        labels = [f"{k}ï¼š{txt}" for k, txt in opts]
        keys = [k for k, _ in opts]

        # ç¾åœ¨é¸æŠ
        current = st.session_state.answers[i]
        index = 0
        if current in keys:
            index = keys.index(current)

        choice_label = st.radio(
            item["q"],
            labels,
            index=index,
            key=f"q_{i}",
            horizontal=False,
        )
        # ãƒ©ãƒ™ãƒ«ã‹ã‚‰ã‚­ãƒ¼ã¸æˆ»ã™
        chosen_key = choice_label.split("ï¼š", 1)[0]
        st.session_state.answers[i] = chosen_key

    st.markdown("---")
    user_note = st.text_area("ä»»æ„ãƒ¡ãƒ¢ï¼ˆä»Šã®æ°—æŒã¡ï¼çŠ¶æ³ï¼‰", placeholder="ä¾‹ï¼šæœ€è¿‘ãšã£ã¨ç„¦ã‚ŠãŒå¼·ã„ã€‚ä½“èª¿ã‚‚ã„ã¾ã„ã¡ã€‚", height=100)

    col1, col2, col3 = st.columns([1, 1, 1])
    with col1:
        do_diag = st.button("ğŸ”® è¨ºæ–­ã™ã‚‹", use_container_width=True)
    with col2:
        save_btn = st.button("ğŸ’¾ ä¿å­˜ã™ã‚‹", use_container_width=True)
    with col3:
        reset_btn = st.button("â†© ãƒªã‚»ãƒƒãƒˆ", use_container_width=True)

    if reset_btn:
        st.session_state.answers = [""] * len(QUESTIONS)
        st.session_state.result = None
        st.rerun()

    if do_diag:
        scores = calc_scores(st.session_state.answers)
        main_key, sub_key = pick_types(scores)
        st.session_state.result = {
            "time": now_str(),
            "answers": st.session_state.answers,
            "scores": scores,
            "main": main_key,
            "sub": sub_key,
            "note": user_note.strip(),
        }

    if st.session_state.result:
        r = st.session_state.result
        main_key = r["main"]
        sub_key = r["sub"]

        st.markdown("## âœ… è¨ºæ–­çµæœ")
        st.markdown(f"### {RESULTS[main_key]['name']}")
        st.markdown(f"{RESULTS[main_key]['subtitle']}")
        st.markdown(RESULTS[main_key]["body"])

        with st.expander("ğŸ“Š ã‚¹ã‚³ã‚¢ã‚’è¦‹ã‚‹"):
            st.write(r["scores"])
            if sub_key:
                st.info(f"ã‚µãƒ–å‚¾å‘ï¼š{RESULTS[sub_key]['name']}")

        st.markdown("### ä¸€è¨€")
        st.markdown("ã‚ãªãŸã¯å£Šã‚Œã¦ã„ãªã„ã‚ˆã€‚**é•·ãé ‘å¼µã‚Šã™ããŸã ã‘**ã€‚ä»Šæ—¥ã¯â€œå›å¾©ã®ä¸€æ­©â€ã‚’é¸ã¼ã†ã€‚")

        share_text = build_share_text(main_key, sub_key, r.get("note", ""))
        st.markdown("### ğŸ“£ ã‚·ã‚§ã‚¢ç”¨ï¼ˆX/Noteï¼‰")
        st.text_area("ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ã£ã¦ã­", value=share_text, height=180)

        if save_btn:
            history = load_history()
            history.insert(0, r)  # æœ€æ–°ã‚’å…ˆé ­ã¸
            save_history(history)
            st.success("ä¿å­˜ã—ãŸã‚ˆï¼ˆdata/history.jsonï¼‰")

with tab2:
    st.subheader("å±¥æ­´ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰")
    history = load_history()

    if not history:
        st.info("ã¾ã å±¥æ­´ãŒãªã„ã‚ˆã€‚è¨ºæ–­ã—ã¦ã€Œä¿å­˜ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ã­ã€‚")
    else:
        st.caption(f"ä¿å­˜ä»¶æ•°ï¼š{len(history)}ï¼ˆdata/history.jsonï¼‰")
        for idx, h in enumerate(history[:30], start=1):
            main_key = h.get("main", "A")
            sub_key = h.get("sub")
            time = h.get("time", "-")
            note = h.get("note", "")

            with st.expander(f"{idx}. {time}ï½œ{RESULTS[main_key]['name']}"):
                if sub_key:
                    st.write(f"ã‚µãƒ–å‚¾å‘ï¼š{RESULTS[sub_key]['name']}")
                st.write("ã‚¹ã‚³ã‚¢ï¼š", h.get("scores", {}))
                if note:
                    st.write("ãƒ¡ãƒ¢ï¼š", note)

        if st.button("âš  å±¥æ­´ã‚’å…¨å‰Šé™¤ï¼ˆå–ã‚Šæ¶ˆã—ä¸å¯ï¼‰", type="secondary"):
            save_history([])
            st.success("å±¥æ­´ã‚’å‰Šé™¤ã—ãŸã‚ˆã€‚")
            st.rerun()

st.markdown("---")
st.caption("â€»ã“ã®ã‚¢ãƒ—ãƒªã¯å†…è¦³ã‚µãƒãƒ¼ãƒˆã§ã™ã€‚å¼·ã„ä¸èª¿ã‚„å±é™ºã‚’æ„Ÿã˜ã‚‹å ´åˆã¯ã€èº«è¿‘ãªäººãƒ»åŒ»ç™‚ãƒ»å…¬çš„çª“å£ã«ç›¸è«‡ã—ã¦ã­ã€‚")
